bettercms.define("bcms.contextMenu",["bcms.jquery","bcms"],function(a,b){var h={isVisible:false},n={links:"a"},g={},f={},c={topLeft:"bcms-media-context-tl",bottomLeft:"bcms-media-context-bl",topRight:"bcms-media-context-tr",bottomRight:"bcms-media-context-br"},e={menuOn:"bcms-context-menu-on",menuOff:"bcms-context-menu-off"},m=false,i=false,j=false,d=null;h.links=g;h.globalization=f;h.selectors=n;h.events=e;function o(p){if(d!=null){h.closeContext();}d=p;}function k(){h.isVisible=false;b.trigger(h.events.menuOn);}function l(){h.isVisible=true;b.trigger(h.events.menuOff);}h.initContext=function(q,r,p){o(q);q.on("mouseover",function(){i=true;});q.on("mouseout",function(){i=false;});q.find(n.links).on("click",h.closeContext);if(p===true){r.on("contextmenu",function(s){h.contextShow(s,null);});}};h.contextMouseDown=function(p){if(j||i){return;}if(p==null){p=window.event;}if(p.button==2){m=true;}else{if(!i){h.closeContext();}}};h.closeContext=function(){i=false;if(d!=null){d.hide();}k();};h.contextShow=function(s,v){if(j||i){return true;}if(s==null){s=window.event;}if(m){if(v){o(v);}d.hide();var u=10,G=14,E=a(s.currentTarget||s.srcElement),t=(s.pageX||s.clientX)-E.offset().left,F=(s.pageY||s.clientY)-E.offset().top,z=d.scrollParent().height(),D=d.scrollParent().width(),B=d.scrollParent().offset(),C=B?B.top:0,A=B?B.left:0,w=d.outerHeight(),x=d.outerWidth(),y=d.parent().offset(),H=(y?y.top:0)+F+w-C,I=(y?y.left:0)+t+x-A+u,p=false,q=false,r;if(H>z){F=F-w+G;p=true;}else{F-=G;}if(I>D){t=t-x-u;q=true;}else{t+=u;}d.removeClass(c.bottomLeft);d.removeClass(c.bottomRight);d.removeClass(c.topLeft);d.removeClass(c.topRight);r=(p)?(q?c.bottomRight:c.bottomLeft):(q?c.topRight:c.topLeft);d.addClass(r);d.css("left",t+"px");d.css("top",F+"px");d.css("z-index",b.getHighestZindex()+1);d.show();m=false;l();return false;}return true;};h.disableContext=function(){j=true;h.closeContext();return false;};h.enableContext=function(){j=false;i=false;return false;};h.init=function(){b.logger.debug("Initializing bcms.contextMenu module.");a(document).on("mousedown",h.contextMouseDown);};b.registerInit(h.init);return h;});bettercms.define("bcms.html5Upload",["bcms.jquery","bcms"],function(a,b){var d={},e=function(){},f;function g(h){var i=this;i.dropContainer=h.dropContainer;i.inputField=h.inputField;i.uploadsQueue=[];i.activeUploads=0;i.data=h.data;i.key=h.key;i.maxSimultaneousUploads=h.maxSimultaneousUploads||-1;i.onFileAdded=h.onFileAdded||e;i.uploadUrl=h.uploadUrl;i.onFileAddedProxy=function(j){b.logger.trace("Event: onFileAdded, file: "+j.fileName);i.onFileAdded(j);};i.initialize();}function c(h){var i=this;i.file=h;i.fileName=h.name;i.fileSize=h.size;i.uploadSize=h.size;i.uploadedBytes=0;i.eventHandlers={};i.abort=function(){b.logger.warn("Abort impossible. File upload not initialized for file "+i.fileName);};i.events={onProgress:function(j,l){var k=l/j*100;b.logger.trace("Event: upload onProgress, progress = "+k+", fileSize = "+j+", uploadedBytes = "+l);(i.eventHandlers.onProgress||e)(k,j,l);},onStart:function(){b.logger.trace("Event: upload onStart");(i.eventHandlers.onStart||e)();},onCompleted:function(j){b.logger.trace("Event: upload onCompleted, data = "+j);h=null;(i.eventHandlers.onCompleted||e)(j);},onError:function(k,j){b.logger.trace("Event: upload onError (status code "+k+")");h=null;(i.eventHandlers.onError||e)();},onTransfer:function(j){if(j>=100){j=0;}else{j+=10;}(i.eventHandlers.onTransfer||e)(j);}};}c.prototype={on:function(h){this.eventHandlers=h;}};g.prototype={initialize:function(){b.logger.debug("Initializing upload manager");var k=this,i=k.dropContainer,j=k.inputField,h=function(l){l.preventDefault();l.stopPropagation();};if(i){k.on(i,"dragover",h);k.on(i,"dragenter",h);k.on(i,"drop",function(l){h(l);k.processFiles(l.dataTransfer.files);});}if(j){k.on(j,"change",function(){k.processFiles(this.files);a(this).val("");});}},processFiles:function(j){b.logger.trace("Processing files: "+j.length);var m=this,l=j.length,h,n,k;for(k=0;k<l;k+=1){h=j[k];if(h.size===0){alert("Files with files size zero cannot be uploaded or multiple file uploads are not supported by your browser");break;}n=new c(h);m.uploadFile(n);}},uploadFile:function(i){var h=this;h.onFileAdded(i);if(h.activeUploads===h.maxSimultaneousUploads){b.logger.trace("Queue upload: "+i.fileName);h.uploadsQueue.push(i);return;}h.ajaxUpload(i);},ajaxUpload:function(o){var m=this,p,k,j,i=o.file,n,h=m.data,l=m.key||"file";b.logger.trace("Begin upload: "+o.fileName);m.activeUploads+=1;p=new window.XMLHttpRequest();k=new window.FormData();j=i.name;p.open("POST",m.uploadUrl);p.upload.onloadstart=function(){b.logger.trace("Upload started: "+j);o.events.onStart();};p.upload.onprogress=function(q){if(!q.lengthComputable){return;}o.events.onProgress(q.total,q.loaded);if(q.total==q.loaded){o.events.onTransfer();}};p.onload=function(q){b.logger.trace("Upload completed: "+j);m.activeUploads-=1;if(q.target.status===200){o.events.onCompleted(q.target.responseText);}else{o.events.onError(q.target.status,q.target.responseText);}if(m.uploadsQueue.length){m.ajaxUpload(m.uploadsQueue.shift());}};p.onerror=function(q){b.logger.error("Upload failed: ",o.fileName);o.events.onError(q.target.status,q.target.responseText);};if(h){for(n in h){if(h.hasOwnProperty(n)){b.logger.trace("Adding data: "+n+" = "+h[n]);k.append(n,h[n]);}}}k.append(l,i);p.send(k);o.abort=function(){b.logger.trace("Upload aborted for "+o.fileName);p.abort();m.activeUploads-=1;if(m.uploadsQueue.length){m.ajaxUpload(m.uploadsQueue.shift());}};},on:function(h,i,j){if(!h){return;}if(h.addEventListener){h.addEventListener(i,j,false);}else{if(h.attachEvent){h.attachEvent("on"+i,j);}else{h["on"+i]=j;}}}};d.fileApiSupported=function(){if(typeof f!=="boolean"){var h=document.createElement("input");h.setAttribute("type","file");f=!!h.files;}return f;};d.initialize=function(h){return new g(h);};return d;});bettercms.define("bcms.jquery.jcrop",["bcms.jquery"],function(a){(function(b){b.Jcrop=function(S,U){var V=b.extend({},b.Jcrop.defaults),D,O,J=false;function X(ax){return ax+"px";}function A(ax){return V.baseClass+"-"+ax;}function aj(){return b.fx.step.hasOwnProperty("backgroundColor");}function I(ax){var ay=b(ax).offset();return[ay.left,ay.top];}function P(ax){return[(ax.pageX-D[0]),(ax.pageY-D[1])];}function ac(ax){if(typeof(ax)!=="object"){ax={};}V=b.extend(V,ax);b.each(["onChange","onSelect","onRelease","onDblClick"],function(az,ay){if(typeof(V[ay])!=="function"){V[ay]=function(){};}});}function ai(ay,aB){D=I(e);ao.setCursor(ay==="move"?ay:ay+"-resize");if(ay==="move"){return ao.activateHandlers(z(aB),E);}var ax=v.getFixed();var aA=T(ay);var az=v.getCorner(T(aA));v.setPressed(v.getCorner(aA));v.setCurrent(az);ao.activateHandlers(F(ay,ax),E);}function F(ay,ax){return function(az){if(!V.aspectRatio){switch(ay){case"e":az[1]=ax.y2;break;case"w":az[1]=ax.y2;break;case"n":az[0]=ax.x2;break;case"s":az[0]=ax.x2;break;}}else{switch(ay){case"e":az[1]=ax.y+1;break;case"w":az[1]=ax.y+1;break;case"n":az[0]=ax.x+1;break;case"s":az[0]=ax.x+1;break;}}v.setCurrent(az);Z.update();};}function z(ay){var ax=ay;N.watchKeys();return function(az){v.moveOffset([az[0]-ax[0],az[1]-ax[1]]);ax=az;Z.update();};}function T(ax){switch(ax){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne";}}function w(ax){return function(ay){if(V.disabled){return false;}if((ax==="move")&&!V.allowMove){return false;}D=I(e);s=true;ai(ax,P(ay));ay.stopPropagation();ay.preventDefault();return false;};}function W(ax,aB,ay){var aA=ax.width(),az=ax.height();if((aA>aB)&&aB>0){aA=aB;az=(aB/ax.width())*ax.height();}if((az>ay)&&ay>0){az=ay;aA=(ay/ax.height())*ax.width();}at=ax.width()/aA;aw=ax.height()/az;ax.width(aA).height(az);}function ap(ax){return{x:ax.x*at,y:ax.y*aw,x2:ax.x2*at,y2:ax.y2*aw,w:ax.w*at,h:ax.h*aw};}function E(ay){var ax=v.getFixed();if((ax.w>V.minSelect[0])&&(ax.h>V.minSelect[1])){Z.enableHandles();Z.done();}else{Z.release();}ao.setCursor(V.allowSelect?"crosshair":"default");}function Q(ax){if(V.disabled){return false;}if(!V.allowSelect){return false;}s=true;D=I(e);Z.disableHandles();ao.setCursor("crosshair");var ay=P(ax);v.setPressed(ay);Z.update();ao.activateHandlers(Y,E);N.watchKeys();ax.stopPropagation();ax.preventDefault();return false;}function Y(ax){v.setCurrent(ax);Z.update();}function R(){var ax=b("<div></div>").addClass(A("tracker"));if(b.browser.msie){ax.css({opacity:0,backgroundColor:"white"});}return ax;}if(b.browser.msie&&(b.browser.version.split(".")[0]==="6")){J=true;}if(typeof(S)!=="object"){S=b(S)[0];}if(typeof(U)!=="object"){U={};}ac(U);var K={border:"none",visibility:"visible",margin:0,padding:0,position:"absolute",top:0,left:0};var h=b(S),L=true;if(S.tagName=="IMG"){if(h[0].width!=0&&h[0].height!=0){h.width(h[0].width);h.height(h[0].height);}else{var am=new Image();am.src=h[0].src;h.width(am.width);h.height(am.height);}var e=h.clone().removeAttr("id").css(K).show();e.width(h.width());e.height(h.height());h.after(e).hide();}else{e=h.css(K).show();L=false;if(V.shade===null){V.shade=true;}}W(e,V.boxWidth,V.boxHeight);var q=e.width(),r=e.height(),c=b("<div />").width(q).height(r).addClass(A("holder")).css({position:"relative",backgroundColor:V.bgColor}).insertAfter(h).append(e);if(V.addClass){c.addClass(V.addClass);}var g=b("<div />"),f=b("<div />").width("100%").height("100%").css({zIndex:310,position:"absolute",overflow:"hidden"}),d=b("<div />").width("100%").height("100%").css("zIndex",320),i=b("<div />").css({position:"absolute",zIndex:600}).dblclick(function(){var ax=v.getFixed();V.onDblClick.call(m,ax);}).insertBefore(e).append(f,d);if(L){g=b("<img />").attr("src",e.attr("src")).css(K).width(q).height(r),f.append(g);}if(J){i.css({overflowY:"hidden"});}var p=V.boundary;var j=R().width(q+(p*2)).height(r+(p*2)).css({position:"absolute",top:X(-p),left:X(-p),zIndex:290}).mousedown(Q);var n=V.bgColor,o=V.bgOpacity,aq,au,ar,av,at,aw,H=true,s,l,ah;D=I(e);var an=(function(){function ay(){var aF={},aC=["touchstart","touchmove","touchend"],az=document.createElement("div"),aD;try{for(aD=0;aD<aC.length;aD++){var aB=aC[aD];aB="on"+aB;var aE=(aB in az);if(!aE){az.setAttribute(aB,"return;");aE=typeof az[aB]=="function";}aF[aC[aD]]=aE;}return aF.touchstart&&aF.touchend&&aF.touchmove;}catch(aA){return false;}}function ax(){if((V.touchSupport===true)||(V.touchSupport===false)){return V.touchSupport;}else{return ay();}}return{createDragger:function(az){return function(aA){aA.pageX=aA.originalEvent.changedTouches[0].pageX;aA.pageY=aA.originalEvent.changedTouches[0].pageY;if(V.disabled){return false;}if((az==="move")&&!V.allowMove){return false;}s=true;ai(az,P(aA));aA.stopPropagation();aA.preventDefault();return false;};},newSelection:function(az){az.pageX=az.originalEvent.changedTouches[0].pageX;az.pageY=az.originalEvent.changedTouches[0].pageY;return Q(az);},isSupported:ay,support:ax()};}());var v=(function(){var aJ=0,aL=0,aK=0,aM=0,aE,aF;function aI(aN){aN=aG(aN);aK=aJ=aN[0];aM=aL=aN[1];}function aH(aN){aN=aG(aN);aE=aN[0]-aK;aF=aN[1]-aM;aK=aN[0];aM=aN[1];}function aA(){return[aE,aF];}function aD(aN){var aO=aN[0],aP=aN[1];if(0>aJ+aO){aO-=aO+aJ;}if(0>aL+aP){aP-=aP+aL;}if(r<aM+aP){aP+=r-(aM+aP);}if(q<aK+aO){aO+=q-(aK+aO);}aJ+=aO;aK+=aO;aL+=aP;aM+=aP;}function ay(aO){var aN=az();switch(aO){case"ne":return[aN.x2,aN.y];case"nw":return[aN.x,aN.y];case"se":return[aN.x2,aN.y2];case"sw":return[aN.x,aN.y2];}}function az(){if(!V.aspectRatio){return aB();}var aN=V.aspectRatio,aR=V.minSize[0]/at,aP=V.maxSize[0]/at,aQ=V.maxSize[1]/aw,aV=aK-aJ,aT=aM-aL,aW=Math.abs(aV),aU=Math.abs(aT),aS=aW/aU,aY,aZ,aX,aO;if(aP===0){aP=q*10;}if(aQ===0){aQ=r*10;}if(aS<aN){aZ=aM;aX=aU*aN;aY=aV<0?aJ-aX:aX+aJ;if(aY<0){aY=0;aO=Math.abs((aY-aJ)/aN);aZ=aT<0?aL-aO:aO+aL;}else{if(aY>q){aY=q;aO=Math.abs((aY-aJ)/aN);aZ=aT<0?aL-aO:aO+aL;}}}else{aY=aK;aO=aW/aN;aZ=aT<0?aL-aO:aL+aO;if(aZ<0){aZ=0;aX=Math.abs((aZ-aL)*aN);aY=aV<0?aJ-aX:aX+aJ;}else{if(aZ>r){aZ=r;aX=Math.abs(aZ-aL)*aN;aY=aV<0?aJ-aX:aX+aJ;}}}if(aY>aJ){if(aY-aJ<aR){aY=aJ+aR;}else{if(aY-aJ>aP){aY=aJ+aP;}}if(aZ>aL){aZ=aL+(aY-aJ)/aN;}else{aZ=aL-(aY-aJ)/aN;}}else{if(aY<aJ){if(aJ-aY<aR){aY=aJ-aR;}else{if(aJ-aY>aP){aY=aJ-aP;}}if(aZ>aL){aZ=aL+(aJ-aY)/aN;}else{aZ=aL-(aJ-aY)/aN;}}}if(aY<0){aJ-=aY;aY=0;}else{if(aY>q){aJ-=aY-q;aY=q;}}if(aZ<0){aL-=aZ;aZ=0;}else{if(aZ>r){aL-=aZ-r;aZ=r;}}return aC(ax(aJ,aL,aY,aZ));}function aG(aN){if(aN[0]<0){aN[0]=0;}if(aN[1]<0){aN[1]=0;}if(aN[0]>q){aN[0]=q;}if(aN[1]>r){aN[1]=r;}return[aN[0],aN[1]];}function ax(aN,aR,aO,aS){var aP=aN,aQ=aO,aT=aR,aU=aS;if(aO<aN){aP=aO;aQ=aN;}if(aS<aR){aT=aS;aU=aR;}return[aP,aT,aQ,aU];}function aB(){var aO=aK-aJ,aP=aM-aL,aN;if(aq&&(Math.abs(aO)>aq)){aK=(aO>0)?(aJ+aq):(aJ-aq);}if(au&&(Math.abs(aP)>au)){aM=(aP>0)?(aL+au):(aL-au);}if(av/aw&&(Math.abs(aP)<av/aw)){aM=(aP>0)?(aL+av/aw):(aL-av/aw);}if(ar/at&&(Math.abs(aO)<ar/at)){aK=(aO>0)?(aJ+ar/at):(aJ-ar/at);}if(aJ<0){aK-=aJ;aJ-=aJ;}if(aL<0){aM-=aL;aL-=aL;}if(aK<0){aJ-=aK;aK-=aK;}if(aM<0){aL-=aM;aM-=aM;}if(aK>q){aN=aK-q;aJ-=aN;aK-=aN;}if(aM>r){aN=aM-r;aL-=aN;aM-=aN;}if(aJ>q){aN=aJ-r;aM-=aN;aL-=aN;}if(aL>r){aN=aL-r;aM-=aN;aL-=aN;}return aC(ax(aJ,aL,aK,aM));}function aC(aN){return{x:aN[0],y:aN[1],x2:aN[2],y2:aN[3],w:aN[2]-aN[0],h:aN[3]-aN[1]};}return{flipCoords:ax,setPressed:aI,setCurrent:aH,getOffset:aA,moveOffset:aD,getCorner:ay,getFixed:az};}());var ag=(function(){var az=false,aC=b("<div />").css({position:"absolute",zIndex:240,opacity:0}),aH={top:ax(),left:ax().height(r),right:ax().height(r),bottom:ax()};function aE(aL,aK){aH.left.css({height:X(aK)});aH.right.css({height:X(aK)});}function aI(){return aJ(v.getFixed());}function aJ(aK){aH.top.css({left:X(aK.x),width:X(aK.w),height:X(aK.y)});aH.bottom.css({top:X(aK.y2),left:X(aK.x),width:X(aK.w),height:X(r-aK.y2)});aH.right.css({left:X(aK.x2),width:X(q-aK.x2)});aH.left.css({width:X(aK.x)});}function ax(){return b("<div />").css({position:"absolute",backgroundColor:V.shadeColor||V.bgColor}).appendTo(aC);}function aA(){if(!az){az=true;aC.insertBefore(e);aI();Z.setBgOpacity(1,0,1);g.hide();aF(V.shadeColor||V.bgColor,1);if(Z.isAwake()){aG(V.bgOpacity,1);}else{aG(1,1);}}}function aF(aK,aL){u(aB(),aK,aL);}function ay(){if(az){aC.remove();g.show();az=false;if(Z.isAwake()){Z.setBgOpacity(V.bgOpacity,1,1);}else{Z.setBgOpacity(1,1,1);Z.disableHandles();}u(c,0,1);}}function aG(aL,aK){if(az){if(V.bgFade&&!aK){aC.animate({opacity:1-aL},{queue:false,duration:V.fadeTime});}else{aC.css({opacity:1-aL});}}}function aD(){V.shade?aA():ay();if(Z.isAwake()){aG(V.bgOpacity);}}function aB(){return aC.children();}return{update:aI,updateRaw:aJ,getShades:aB,setBgColor:aF,enable:aA,disable:ay,resize:aE,refresh:aD,opacity:aG};}());var Z=(function(){var az,aK=370,aA={},aJ={},aG={},aS=false;function aL(aZ){var aY=b("<div />").css({position:"absolute",opacity:V.borderOpacity}).addClass(A(aZ));f.append(aY);return aY;}function aH(aZ,a0){var aY=b("<div />").mousedown(w(aZ)).css({cursor:aZ+"-resize",position:"absolute",zIndex:a0}).addClass("ord-"+aZ);if(an.support){aY.bind("touchstart.jcrop",an.createDragger(aZ));}d.append(aY);return aY;}function aN(aZ){var aY=V.handleSize;return aH(aZ,aK++).css({opacity:V.handleOpacity}).width(aY).height(aY).addClass(A("handle"));}function aM(aY){return aH(aY,aK++).addClass("jcrop-dragbar");}function aC(aZ){var aY;for(aY=0;aY<aZ.length;aY++){aG[aZ[aY]]=aM(aZ[aY]);}}function aB(a0){var aY,aZ;for(aZ=0;aZ<a0.length;aZ++){switch(a0[aZ]){case"n":aY="hline";break;case"s":aY="hline bottom";break;case"e":aY="vline right";break;case"w":aY="vline";break;}aA[a0[aZ]]=aL(aY);}}function aD(aZ){var aY;for(aY=0;aY<aZ.length;aY++){aJ[aZ[aY]]=aN(aZ[aY]);}}function aO(aY,aZ){if(!V.shade){g.css({top:X(-aZ),left:X(-aY)});}i.css({top:X(aZ),left:X(aY)});}function aR(aZ,aY){i.width(aZ).height(aY);}function aP(){var aY=v.getFixed();v.setPressed([aY.x,aY.y]);v.setCurrent([aY.x2,aY.y2]);aX();}function aX(aY){if(az){return aW(aY);}}function aW(aZ){var aY=v.getFixed();aR(aY.w,aY.h);aO(aY.x,aY.y);if(V.shade){ag.updateRaw(aY);}az||aU();if(aZ){V.onSelect.call(m,ap(aY));}else{V.onChange.call(m,ap(aY));}}function aT(a0,aY,aZ){if(!az&&!aY){return;}if(V.bgFade&&!aZ){e.animate({opacity:a0},{queue:false,duration:V.fadeTime});}else{e.css("opacity",a0);}}function aU(){i.show();if(V.shade){ag.opacity(o);}else{aT(o,true);}az=true;}function aQ(){aE();i.hide();if(V.shade){ag.opacity(1);}else{aT(1);}az=false;V.onRelease.call(m);}function aV(){if(aS){d.show();}}function aI(){aS=true;if(V.allowResize){d.show();return true;}}function aE(){aS=false;d.hide();}function ay(aY){if(l===aY){aE();}else{aI();}}function aF(){ay(false);aP();}if(V.dragEdges&&b.isArray(V.createDragbars)){aC(V.createDragbars);}if(b.isArray(V.createHandles)){aD(V.createHandles);}if(V.drawBorders&&b.isArray(V.createBorders)){aB(V.createBorders);}b(document).bind("touchstart.jcrop-ios",function(aY){if(b(aY.currentTarget).hasClass("jcrop-tracker")){aY.stopPropagation();}});var ax=R().mousedown(w("move")).css({cursor:"move",position:"absolute",zIndex:360});if(an.support){ax.bind("touchstart.jcrop",an.createDragger("move"));}f.append(ax);aE();return{updateVisible:aX,update:aW,release:aQ,refresh:aP,isAwake:function(){return az;},setCursor:function(aY){ax.css("cursor",aY);},enableHandles:aI,enableOnly:function(){aS=true;},showHandles:aV,disableHandles:aE,animMode:ay,setBgOpacity:aT,done:aF};}());var ao=(function(){var az=function(){},ay=function(){},aD=V.trackDocument;function aC(){j.css({zIndex:450});if(an.support){b(document).bind("touchmove.jcrop",aG).bind("touchend.jcrop",aF);}if(aD){b(document).bind("mousemove.jcrop",aE).bind("mouseup.jcrop",aH);}}function aB(){j.css({zIndex:290});b(document).unbind(".jcrop");}function aE(aI){az(P(aI));return false;}function aH(aI){aI.preventDefault();aI.stopPropagation();if(s){s=false;ay(P(aI));if(Z.isAwake()){V.onSelect.call(m,ap(v.getFixed()));}aB();az=function(){};ay=function(){};}return false;}function ax(aJ,aI){s=true;az=aJ;ay=aI;aC();return false;}function aG(aI){aI.pageX=aI.originalEvent.changedTouches[0].pageX;aI.pageY=aI.originalEvent.changedTouches[0].pageY;return aE(aI);}function aF(aI){aI.pageX=aI.originalEvent.changedTouches[0].pageX;aI.pageY=aI.originalEvent.changedTouches[0].pageY;return aH(aI);}function aA(aI){j.css("cursor",aI);}if(!aD){j.mousemove(aE).mouseup(aH).mouseout(aH);}e.before(j);return{activateHandlers:ax,setCursor:aA};}());var N=(function(){var ax=b('<input type="radio" />').css({position:"fixed",left:"-120px",width:"12px"}),ay=b("<div />").css({position:"absolute",overflow:"hidden"}).append(ax);function aC(){if(V.keySupport){ax.show();ax.focus();}}function aA(aD){ax.hide();}function az(aD,aE,aF){if(V.allowMove){v.moveOffset([aE,aF]);Z.updateVisible(true);}aD.preventDefault();aD.stopPropagation();}function aB(aD){if(aD.ctrlKey||aD.metaKey){return true;}ah=aD.shiftKey?true:false;var aE=ah?10:1;switch(aD.keyCode){case 37:az(aD,-aE,0);break;case 39:az(aD,aE,0);break;case 38:az(aD,0,-aE);break;case 40:az(aD,0,aE);break;case 27:if(V.allowSelect){Z.release();}break;case 9:return true;}return false;}if(V.keySupport){ax.keydown(aB).blur(aA);if(J||!V.fixedSupport){ax.css({position:"absolute",left:"-20px"});ay.append(ax).insertBefore(e);}else{ax.insertBefore(e);}}return{watchKeys:aC};}());function aa(ax){c.removeClass().addClass(A("holder")).addClass(ax);}function k(ax,aD){var aN=ax[0]/at,aP=ax[1]/aw,aO=ax[2]/at,aQ=ax[3]/aw;if(l){return;}var aB=v.flipCoords(aN,aP,aO,aQ),aC=v.getFixed(),aE=[aC.x,aC.y,aC.x2,aC.y2],az=aE,aF=V.animationDelay,aG=aB[0]-aE[0],aI=aB[1]-aE[1],aH=aB[2]-aE[2],aJ=aB[3]-aE[3],aK=0,aM=V.swingSpeed;x=az[0];y=az[1];aO=az[2];aQ=az[3];Z.animMode(true);var ay;function aL(){window.setTimeout(aA,aF);}var aA=(function(){return function(){aK+=(100-aK)/aM;az[0]=x+((aK/100)*aG);az[1]=y+((aK/100)*aI);az[2]=aO+((aK/100)*aH);az[3]=aQ+((aK/100)*aJ);if(aK>=99.8){aK=100;}if(aK<100){af(az);aL();}else{Z.done();if(typeof(aD)==="function"){aD.call(m);}}};}());aL();}function ae(ax){af([ax[0]/at,ax[1]/aw,ax[2]/at,ax[3]/aw]);V.onSelect.call(m,ap(v.getFixed()));Z.enableHandles();}function af(ax){v.setPressed([ax[0],ax[1]]);v.setCurrent([ax[2],ax[3]]);Z.update();}function al(){return ap(v.getFixed());}function ak(){return v.getFixed();}function ad(ax){ac(ax);M();}function C(){V.disabled=true;Z.disableHandles();Z.setCursor("default");ao.setCursor("default");}function G(){V.disabled=false;M();}function t(){Z.done();ao.activateHandlers(null,null);}function B(){c.remove();h.show();b(S).removeData("Jcrop");}function ab(az,ax){Z.release();C();var ay=new Image();ay.onload=function(){var aD=ay.width;var aC=ay.height;var aB=V.boxWidth;var aA=V.boxHeight;e.width(aD).height(aC);e.attr("src",az);g.attr("src",az);W(e,aB,aA);q=e.width();r=e.height();g.width(q).height(r);j.width(q+(p*2)).height(r+(p*2));c.width(q).height(r);ag.resize(q,r);G();if(typeof(ax)==="function"){ax.call(m);}};ay.src=az;}function u(ax,ay,aA){var az=ay||V.bgColor;if(V.bgFade&&aj()&&V.fadeTime&&!aA){ax.animate({backgroundColor:az},{queue:false,duration:V.fadeTime});}else{ax.css("backgroundColor",az);}}function M(ax){if(V.allowResize){if(ax){Z.enableOnly();}else{Z.enableHandles();}}else{Z.disableHandles();}ao.setCursor(V.allowSelect?"crosshair":"default");Z.setCursor(V.allowMove?"move":"default");if(V.hasOwnProperty("trueSize")){at=V.trueSize[0]/q;aw=V.trueSize[1]/r;}if(V.hasOwnProperty("setSelect")){ae(V.setSelect);Z.done();delete (V.setSelect);}ag.refresh();if(V.bgColor!=n){u(V.shade?ag.getShades():c,V.shade?(V.shadeColor||V.bgColor):V.bgColor);n=V.bgColor;}if(o!=V.bgOpacity){o=V.bgOpacity;if(V.shade){ag.refresh();}else{Z.setBgOpacity(o);}}aq=V.maxSize[0]||0;au=V.maxSize[1]||0;ar=V.minSize[0]||0;av=V.minSize[1]||0;if(V.hasOwnProperty("outerImage")){e.attr("src",V.outerImage);delete (V.outerImage);}Z.refresh();}if(an.support){j.bind("touchstart.jcrop",an.newSelection);}d.hide();M(true);var m={setImage:ab,animateTo:k,setSelect:ae,setOptions:ad,tellSelect:al,tellScaled:ak,setClass:aa,disable:C,enable:G,cancel:t,release:Z.release,destroy:B,focus:N.watchKeys,getBounds:function(){return[q*at,r*aw];},getWidgetSize:function(){return[q,r];},getScaleFactor:function(){return[at,aw];},getOptions:function(){return V;},ui:{holder:c,selection:i}};if(b.browser.msie){c.bind("selectstart",function(){return false;});}h.data("Jcrop",m);return m;};b.fn.Jcrop=function(e,d){var c;this.each(function(){if(b(this).data("Jcrop")){if(e==="api"){return b(this).data("Jcrop");}else{b(this).data("Jcrop").setOptions(e);}}else{if(this.tagName=="IMG"){b.Jcrop.Loader(this,function(){b(this).css({display:"block",visibility:"hidden"});c=b.Jcrop(this,e);if(b.isFunction(d)){d.call(c);}});}else{b(this).css({display:"block",visibility:"hidden"});c=b.Jcrop(this,e);if(b.isFunction(d)){d.call(c);}}}});return this;};b.Jcrop.Loader=function(g,h,e){var c=b(g),f=c[0];function d(){if(f.complete){c.unbind(".jcloader");if(b.isFunction(h)){h.call(f);}}else{window.setTimeout(d,50);}}c.bind("load.jcloader",d).bind("error.jcloader",function(i){c.unbind(".jcloader");if(b.isFunction(e)){e.call(f);}});if(f.complete&&b.isFunction(h)){c.unbind(".jcloader");h.call(f);}};b.Jcrop.defaults={allowSelect:true,allowMove:true,allowResize:true,trackDocument:true,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:0.6,bgFade:false,borderOpacity:0.4,handleOpacity:1,handleSize:7,aspectRatio:0,keySupport:true,createHandles:["n","s","e","w","nw","ne","se","sw"],createDragbars:["n","s","e","w"],createBorders:["n","s","e","w"],drawBorders:true,dragEdges:true,fixedSupport:true,touchSupport:null,shade:null,boxWidth:0,boxHeight:0,boundary:2,fadeTime:400,animationDelay:20,swingSpeed:3,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){},onDblClick:function(){},onRelease:function(){}};}(a));});bettercms.define("bcms.media.history",["bcms.jquery","bcms","bcms.modal","bcms.messages","bcms.dynamicContent","bcms.redirect","bcms.grid"],function(a,b,j,i,d,l,f){var g={},c={tableActiveRow:"bcms-table-row-active"},o={gridRestoreLinks:"#bcms-pagecontenthistory-form tr .bcms-js-restore",gridDownloadLinks:"#bcms-pagecontenthistory-form tr .bcms-js-download",gridCells:"#bcms-pagecontenthistory-form tr td",gridRowPreviewLink:".bcms-js-preview:first",firstRow:"tr:first",gridRows:"#bcms-pagecontenthistory-form tr",versionPreviewContainer:"#bcms-history-preview",versionPreviewLoaderContainer:".bcms-history-preview-holder",mediaHistoryForm:"#bcms-pagecontenthistory-form",mediaHistorySearchButton:".bcms-btn-search",mediaHistorySearchField:".bcms-js-search-box",modalContent:".bcms-modal-content",popinfoFrame:".bcms-popinfo-frame"},h={loadMediaHistoryDialogUrl:null,loadMediaVersionPreviewUrl:null,restoreMediaVersionUrl:null,downloadFileUrl:null},e={mediaHistoryDialogTitle:null,mediaVersionRestoreConfirmation:null,restoreButtonTitle:null,restoreWithOverrideButtonTitle:null,restoreAsNewVersionButtonTitle:null,closeButtonTitle:null};g.links=h;g.globalization=e;function k(p,q){var u=a.format(h.loadMediaVersionPreviewUrl,q),t=p.find(o.versionPreviewContainer),r=p.find(o.versionPreviewLoaderContainer),s=function(v){r.hideLoading();t.html(v);};t.html("");r.showLoading();a.ajax({type:"GET",cache:false,url:u}).done(function(v){s(v);}).fail(function(v){s(b.parseFailedResponse(v));});}function m(p,t,u){var r;var s=[];var w=null;var x=null;var v=p.find(o.versionPreviewLoaderContainer);if(u&&u==true){var q=new j.button(e.restoreAsNewVersionButtonTitle,null,5,function(){var z=a.format(h.restoreMediaVersionUrl,t,"false"),y=function(B){i.refreshBox(p,B);v.hideLoading();if(B.Success){var A=p.find(o.mediaHistoryForm);A.submit();}};v.showLoading();a.ajax({type:"POST",cache:false,url:z}).done(function(A){y(A);}).fail(function(A){y(b.parseFailedResponse(A));});r.close();});s=[q];w=e.restoreWithOverrideButtonTitle;x=function(){a(o.popinfoFrame).width(400);};}r=j.confirm({content:e.mediaVersionRestoreConfirmation,acceptTitle:e.restoreButtonTitle,onAccept:function(){var z=a.format(h.restoreMediaVersionUrl,t,"true"),y=function(B){i.refreshBox(p,B);if(B.Success){var A=p.find(o.mediaHistoryForm);A.submit();}};v.showLoading();a.ajax({type:"POST",cache:false,url:z}).done(function(A){y(A);}).fail(function(A){y(b.parseFailedResponse(A));});},onShow:x});}function n(q,p,r,s){f.submitGridForm(r,function(t){p.html(t);g.initMediaHistoryDialogEvents(q,s,t,true);});}g.initMediaHistoryDialogEvents=function(r,t,q,u){var p=r.container.find(o.modalContent);p.find(o.gridRestoreLinks).on("click",function(v){b.stopEventPropagation(v);m(p,a(this).data("id"),t);});p.find(o.gridDownloadLinks).on("click",function(v){b.stopEventPropagation(v);window.open(a.format(h.downloadFileUrl,a(this).data("id")),"_newtab");});p.find(o.gridCells).on("click",function(){var y=a(this),x=y.parents(o.firstRow),w=x.find(o.gridRowPreviewLink),v=w.data("id");p.find(o.gridRows).removeClass(c.tableActiveRow);x.addClass(c.tableActiveRow);k(p,v);});var s=p.find(o.mediaHistoryForm);f.bindGridForm(s,function(v){p.html(v);g.initMediaHistoryDialogEvents(r,t);});s.on("submit",function(v){b.stopEventPropagation(v);n(r,p,s,t);return false;});s.find(o.mediaHistorySearchButton).on("click",function(){var v=a(this).parent();if(!v.hasClass("bcms-active-search")){s.find(o.mediaHistorySearchField).prop("disabled",false);v.addClass("bcms-active-search");s.find(o.mediaHistorySearchField).focus();}else{s.find(o.mediaHistorySearchField).prop("disabled",true);v.removeClass("bcms-active-search");s.find(o.mediaHistorySearchField).val("");}});if(u===true){s.find(o.mediaHistorySearchButton).parent().addClass("bcms-active-search");}else{s.find(o.mediaHistorySearchField).prop("disabled",true);}};g.openMediaHistoryDialog=function(q,p,r){j.open({title:e.mediaHistoryDialogTitle,cancelTitle:e.closeButtonTitle,disableAccept:true,onLoad:function(s){var t=a.format(h.loadMediaHistoryDialogUrl,q);d.bindDialog(s,t,{contentAvailable:function(){g.initMediaHistoryDialogEvents(s,p);},beforePost:function(){s.container.showLoading();},postComplete:function(){s.container.hideLoading();}});},onClose:r});};return g;});bettercms.define("bcms.media.imageeditor",["bcms.jquery","bcms","bcms.modal","bcms.siteSettings","bcms.forms","bcms.dynamicContent","bcms.jquery.jcrop","bcms.ko.extenders","bcms.tags","bcms.categories","bcms.media.upload"],function(a,b,s,v,g,e,n,p,w,c,r){var i={},t={imageToEdit:".bcms-croped-block img",imageVersionField:"#image-version-field",imageOverrideField:"#image-override-field",imageCaption:"#Caption",imageFileName:"#image-file-name",imageFileSize:"#image-file-size",imageAlignment:"input[name=ImageAlign]:checked",imageAlignmentControls:".bcms-alignment-controls",imageDimensionsBox:"#bcms-image-dimensions-editor-box",titleEditBox:"#bcms-image-title-editor-box",imageEditorForm:"form:first",imageSizeEditBoxWidth:"#image-width",imageSizeEditBoxHeight:"#image-height",imageTitleEditInput:"#bcms-image-title-editor",imageToCrop:".bcms-croped-block img",selectableInputs:"input.bcms-editor-selectable-field-box"},q={imageEditorDialogUrl:null,imageEditorInsertDialogUrl:null},h={imageEditorDialogTitle:null,imageEditorInsertDialogTitle:null,imageEditorInsertDialogAcceptButton:null,imageEditorUpdateFailureMessageTitle:null,imageEditorUpdateFailureMessageMessage:null,closeButtonTitle:null,imageEditorHasChangesMessage:null,saveButtonTitle:null,saveWithOverrideButtonTitle:null,saveAsNewVersionButtonTitle:null},d={accept:"bcms-modal-accept",acceptAsNew:"bcms-modal-accept-as-new",maxHeightToFit:600,maxWidthToFit:900,jcropBackgroundColor:"#F5F5F5"},o=null;i.links=q;i.globalization=h;i.onEditImage=function(z,y){i.showImageEditorDialog(z,y);};i.onInsertImage=function(z,y){i.showImageEditorInsertDialog(z,y);};i.showImageEditorDialog=function(z,y){var B=new s.button(h.saveAsNewVersionButtonTitle,"bcms-btn-primary bcms-modal-accept-as-new",5,function(){a(t.imageOverrideField).val(false);A.acceptClick();}),A;A=s.open({title:h.imageEditorDialogTitle,buttons:[B],onLoad:function(C){var D=a.format(q.imageEditorDialogUrl,z);e.bindDialog(C,D,{contentAvailable:function(E,F){l(E,F,y);},beforePost:function(){var E=a(t.imageToEdit).data("version");if(E>0){a(t.imageVersionField).val(E);}},postSuccess:function(E){if(E.Success){y(E.Data);}C.close();}});},onAccept:function(){},onClose:function(){}});A.disableExtraButtons();};i.showImageEditorInsertDialog=function(z,y){s.open({title:h.imageEditorInsertDialogTitle,acceptTitle:h.imageEditorInsertDialogAcceptButton,onLoad:function(A){var B=a.format(q.imageEditorInsertDialogUrl,z.id());e.setContentFromUrl(A,B,{done:function(){m(A);}});},onAccept:function(C){var D=C.container.find(t.imageToEdit).attr("src"),B=C.container.find(t.imageCaption).val(),A=C.container.find(t.imageAlignment).val();C.close();y(z,D,B,A);return false;}});};i.calculateImageDimensionsToFit=function(E,z,B,A,y){if(y||z>A||E>B){var C=B>0?E/B:0,D=A>0?z/A:0;if(C>D){E=B;z=C>0?z/C:0;}else{z=A;E=D>0?E/D:0;}}return{width:E,height:z};};var f=(function(){function y(A,z){var B=this;B.dialog=A;B.boxSelector=z;B.isOpened=p.observable(false);B.open=function(){B.isOpened(true);};B.close=function(){if(B.onClose()){B.isOpened(false);}};B.save=function(C){if(B.onSave(a(C))){B.isOpened(false);}};}y.prototype.onSave=function(){};y.prototype.onClose=function(){};return y;})();var x=(function(y){b.extendsClass(z,y);function z(A,C){y.call(this,A,t.titleEditBox);var B=this;B.input=A.container.find(t.imageTitleEditInput);B.title=p.observable(C);B.oldTitle=p.observable(C);}z.prototype.onSave=function(){if(this.input.valid()){this.oldTitle(this.title());return true;}return false;};z.prototype.onClose=function(){this.title(this.oldTitle());this.input.blur();return true;};return z;})(f);var j=(function(y){b.extendsClass(z,y);function z(C,F,D){y.call(this,C,t.imageDimensionsBox);var I=this;I.enableCrop=D&&F.ImageType===1;I.widthInput=C.container.find(t.imageSizeEditBoxWidth);I.heightInput=C.container.find(t.imageSizeEditBoxHeight);I.image=C.container.find(t.imageToCrop);I.originalWidth=F.OriginalImageWidth;I.originalHeight=F.OriginalImageHeight;I.width=p.observable(F.ImageWidth);I.height=p.observable(F.ImageHeight);I.oldWidth=p.observable(F.ImageWidth);I.oldHeight=p.observable(F.ImageHeight);I.cropHeight=p.observable(F.CroppedHeight);I.cropWidth=p.observable(F.CroppedWidth);I.fit=p.observable(false);I.imageType=p.observable(F.ImageType);I.calculatedWidth=p.observable(F.ImageWidth);I.calculatedHeight=p.observable(F.ImageHeight);I.cropCoordX1=p.observable(F.CropCoordX1);I.cropCoordX2=p.observable(F.CropCoordX2);I.cropCoordY1=p.observable(F.CropCoordY1);I.cropCoordY2=p.observable(F.CropCoordY2);I.url=F.OriginalImageUrl;I.fit.subscribe(function(){G();});I.oldWidth.subscribe(function(){G();});I.oldHeight.subscribe(function(){G();});I.widthAndHeight=p.computed(function(){if(I.oldWidth()==-1||I.oldHeight()==-1){return"Auto";}return I.oldWidth()+" x "+I.oldHeight();});I.changeHeight=function(){if(I.widthInput.valid()&&I.oldWidth!=I.width()){var J=I.width()/(I.originalWidth||1);I.height(Math.round(I.originalHeight*J));}return true;};I.changeWidth=function(){if(I.heightInput.valid()&&I.oldHeight!=I.height()){var J=I.height()/(I.originalHeight||1);I.width(Math.round(I.originalWidth*J));}return true;};I.calculateWidth=p.computed(function(){if(I.fit()&&I.width()>d.maxWidthToFit){return d.maxWidthToFit;}return I.width();});I.calculateHeight=p.computed(function(){if(I.fit()&&I.height()>d.maxHeightToFit){return d.maxHeightToFit;}return I.height();});I.restoreOriginalSize=function(){I.width(I.originalWidth);I.height(I.originalHeight);I.widthInput.valid();I.heightInput.valid();};I.onCropCoordsUpdated=function(J){if(J!=null){I.cropCoordX1(J.x);I.cropCoordY1(J.y);I.cropCoordX2(J.x2);I.cropCoordY2(J.y2);H();}else{I.removeCrop();}};I.onCropChanged=function(J){I.onCropCoordsUpdated(J);};I.hasCrop=p.computed(function(){return I.cropCoordX1()!=0||I.cropCoordY1()!=0||I.cropCoordX2()!=I.originalWidth||I.cropCoordY2()!=I.originalHeight;});I.croppedWidthAndHeight=p.computed(function(){return I.cropWidth()+" x "+I.cropHeight();});I.removeCrop=function(){I.cropCoordX1(0);I.cropCoordY1(0);I.cropCoordX2(I.originalWidth);I.cropCoordY2(I.originalHeight);H();A();};I.changeFit=function(){I.fit(!I.fit());};function H(){var N=I.oldWidth(),J=I.oldHeight(),L=I.originalWidth,K=I.originalHeight,P=I.cropCoordX1(),Q=I.cropCoordX2(),S=I.cropCoordY1(),T=I.cropCoordY2(),O,R,M;if(I.hasCrop()){if(N!=L&&L){M=N/L;O=parseInt(Math.floor(Q*M))-parseInt(Math.floor(P*M));}else{O=Math.floor(Q)-Math.floor(P);}if(J!=K&&K){M=J/K;R=parseInt(Math.floor(T*M))-parseInt(Math.floor(S*M));}else{R=Math.floor(T)-Math.floor(S);}}else{O=I.oldWidth();R=I.oldHeight();}I.cropWidth(O);I.cropHeight(R);}function G(){var K=I.oldWidth(),J=I.oldHeight(),L;if(I.fit()){L=i.calculateImageDimensionsToFit(K,J,d.maxWidthToFit,d.maxHeightToFit);K=L.width;J=L.height;}I.calculatedWidth(K);I.calculatedHeight(J);if(o!=null){A();}H();}function E(){B();o=null;I.image.load(function(){I.fit(true);A();});I.image.attr("src",I.url);}function A(){if(!I.enableCrop){return;}B();var J={onChange:I.onCropChanged,onSelect:I.onCropCoordsUpdated,onRelease:I.onCropCoordsUpdated,trueSize:[I.originalWidth,I.originalHeight],bgColor:d.jcropBackgroundColor};if(I.hasCrop()){J.setSelect=[I.cropCoordX1(),I.cropCoordY1(),I.cropCoordX2(),I.cropCoordY2()];}setTimeout(function(){I.image.Jcrop(J,function(){o=this;});},10);}function B(){if(o!=null){o.destroy();}}E();}z.prototype.onSave=function(A){if(A.get(0)==this.widthInput.get(0)){this.changeHeight();}else{if(A.get(0)==this.heightInput.get(0)){this.changeWidth();}}if(this.widthInput.valid()&&this.heightInput.valid()){this.oldWidth(this.width());this.oldHeight(this.height());return true;}return false;};z.prototype.onClose=function(){this.width(this.oldWidth());this.height(this.oldHeight());this.heightInput.blur();this.widthInput.blur();return true;};return z;})(f);function k(A,z,C){var D=this,F=new x(A,z.Title),B=new j(A,z,true),y=new c.CategoriesSelectListModel(z.Categories),E=new w.TagsListViewModel(z.Tags);D.titleEditorViewModel=F;D.imageEditorViewModel=B;D.categories=y;D.tags=E;D.accessButton=p.utils.arrayFirst(A.model.buttons(),function(G){return G.css().indexOf(d.accept)>0;});D.accessAsNewButton=p.utils.arrayFirst(A.model.buttons(),function(G){return G.css().indexOf(d.acceptAsNew)>0;});D.imageAlign=p.observable(z.ImageAlign);D.modelChanged=false;D.onValueChange=function(){D.modelChanged=true;};D.onImageChanged=function(){D.modelModified=B.width()!=String(z.ImageWidth)||B.height()!=String(z.ImageHeight)||Math.round(B.cropCoordX1())!=String(z.CropCoordX1)||Math.round(B.cropCoordX2())!=String(z.CropCoordX2)||Math.round(B.cropCoordY1())!=String(z.CropCoordY1)||Math.round(B.cropCoordY2())!=String(z.CropCoordY2);if(D.accessAsNewButton){D.accessAsNewButton.disabled(true);}};B.cropCoordX1.subscribe(D.onValueChange);B.cropCoordX2.subscribe(D.onValueChange);B.cropCoordY1.subscribe(D.onValueChange);B.cropCoordY2.subscribe(D.onValueChange);B.oldWidth.subscribe(D.onValueChange);B.oldHeight.subscribe(D.onValueChange);E.items.subscribe(D.onValueChange);D.imageAlign.subscribe(D.onValueChange);B.cropCoordX1.subscribe(D.onImageChanged);B.cropCoordX2.subscribe(D.onImageChanged);B.cropCoordY1.subscribe(D.onImageChanged);B.cropCoordY2.subscribe(D.onImageChanged);B.oldWidth.subscribe(D.onImageChanged);B.oldHeight.subscribe(D.onImageChanged);D.reupload=function(){var G=function(){r.openReuploadFilesDialog(z.Id,z.FolderId||"",1,function(H){i.showImageEditorDialog(z.Id,C);if(H&&H.Data&&H.Data.Medias&&H.Data.Medias.length>0){C(H.Data.Medias[0]);}},function(){i.showImageEditorDialog(z.Id,C);});};if(D.modelChanged){s.confirmWithDecline({content:h.imageEditorHasChangesMessage,onAccept:function(){if(a.isFunction(A.options.onAccept)){var H=A.options.onAccept;A.options.onAccept=function(I){H(I);G();};}else{A.options.onAccept=function(){G();};}A.container.find(t.imageEditorForm).submit();},onDecline:function(){G();A.close();return true;}});}else{A.close();G();}};}function l(B,z,y){var A=z.Data?z.Data:{};var C=new k(B,A,y);c.initCategoriesSelect(C.categories,A.CategoriesLookupList,B.container);p.applyBindings(C,B.container.find(t.imageEditorForm).get(0));B.container.find(t.imageAlignmentControls).children().each(function(){u(this,B,C);});B.container.find(t.selectableInputs).on("click",function(){this.select();});}function m(y){y.container.find(t.imageAlignmentControls).children().each(function(){u(this,y,null);});y.container.find(t.selectableInputs).on("click",function(){this.select();});}function u(z,y,A){a(z).on("click",function(){y.container.find(t.imageAlignmentControls).children().each(function(){a(this).attr("class",a(this).attr("class").replace("-active",""));a("input",this).removeAttr("checked");});a(z).attr("class",a(z).attr("class")+"-active");a("input",z).attr("checked","true");if(A&&a.isFunction(A.imageAlign)){A.imageAlign(a("input",z).val());}});}return i;});bettercms.define("bcms.media.fileeditor",["bcms.jquery","bcms","bcms.modal","bcms.siteSettings","bcms.forms","bcms.dynamicContent","bcms.ko.extenders","bcms.tags","bcms.categories","bcms.security","bcms.media.upload"],function(a,b,n,q,g,d,j,r,c,o,m){var e={},p={fileToEdit:".bcms-croped-block img",fileVersionField:"#image-version-field",fileCaption:"#Caption",fileFileName:"#image-file-name",fileFileSize:"#image-file-size",fileEditorForm:"form:first",fileTitleEditInput:"#bcms-image-title-editor",selectableInputs:"input.bcms-editor-selectable-field-box"},k={fileEditorDialogUrl:null},h={fileEditorDialogTitle:null,fileEditorUpdateFailureMessageTitle:null,fileEditorUpdateFailureMessageMessage:null,fileEditorHasChangesMessage:null},l=null;e.links=k;e.globalization=h;e.SetMedia=function(s){l=s;};e.onEditFile=function(t,s){e.showFileEditorDialog(t,s);};e.showFileEditorDialog=function(t,s){n.open({title:h.fileEditorDialogTitle,onLoad:function(u){var v=a.format(k.fileEditorDialogUrl,t);d.bindDialog(u,v,{contentAvailable:function(w,x){i(w,x,s);},beforePost:function(){var w=a(p.fileToEdit).data("version");if(w>0){a(p.fileVersionField).val(w);}},postSuccess:function(w){if(w.Success){s(w.Data);}u.close();}});}});};function f(v,u,z){var A=this,B=new r.TagsListViewModel(u.Tags),t=new c.CategoriesSelectListModel(u.Categories),s=o.createUserAccessViewModel(u.UserAccessList),x=u.Image,C=s.UserAccessList(),y=C.length,w;A.tags=B;A.categories=t;A.image=j.observable(new l.ImageSelectorViewModel(x));A.accessControl=s;A.modelChanged=false;A.onValueChange=function(){A.modelChanged=true;};A.image().id.subscribe(A.onValueChange);B.items.subscribe(A.onValueChange);s.UserAccessList.subscribe(A.onValueChange);for(w=0;w<y;w++){C[w].AccessLevel.subscribe(A.onValueChange);}A.reupload=function(){var D=function(){m.openReuploadFilesDialog(u.Id,u.FolderId||"",4,function(E){e.showFileEditorDialog(u.Id,z);if(E&&E.Data&&E.Data.Medias&&E.Data.Medias.length>0){z(E.Data.Medias[0]);}},function(){e.showFileEditorDialog(u.Id,z);});};if(A.modelChanged){n.confirmWithDecline({content:h.fileEditorHasChangesMessage,onAccept:function(){if(a.isFunction(v.options.onAccept)){var E=v.options.onAccept;v.options.onAccept=function(F){E(F);D();};}else{v.options.onAccept=function(){D();};}v.container.find(p.fileEditorForm).submit();},onDecline:function(){D();v.close();return true;}});}else{v.close();D();}};}function i(t,s,u){var v=new f(t,s.Data,u);c.initCategoriesSelect(v.categories,s.Data.CategoriesLookupList,t.container);j.applyBindings(v,t.container.find(p.fileEditorForm).get(0));t.container.find(p.selectableInputs).on("click",function(){this.select();});}return e;});bettercms.define("bcms.media",["bcms.jquery","bcms","bcms.modal","bcms.siteSettings","bcms.forms","bcms.dynamicContent","bcms.messages","bcms.media.upload","bcms.media.imageeditor","bcms.htmlEditor","bcms.ko.extenders","bcms.contextMenu","bcms.security","bcms.media.history","bcms.media.fileeditor","bcms.tags","bcms.categories","bcms.options","bcms.store"],function(a,f,ad,ap,y,r,ac,Z,D,C,L,ab,am,B,u,au,j,aj,at){var O={},ao={tabImagesContainer:"#bcms-tab-1",tabFilesContainer:"#bcms-tab-2",tabImagesSelector:"#bcms-tab-images",tabFilesSelector:"#bcms-tab-files",templateDataBind:".bcms-data-bind-container",firstForm:"form:first",spinContainer:".bcms-js-settings-window:first",insertContentContainer:".bcms-insert-content-modal:first",searchBox:"#bcms-search-input",fileListMessageBox:"#bcms-site-settings-media-messages-",filterCategoriesSelect:"#bcms-js-categories-select",previewBox:"#bcms-media-properties-preview",filesTabMessageBox:"#bcms-media-manager-messages",filesTabMessageBoxCloseButton:"#bcms-media-manager-messages .bcms-js-btn-close"},M={loadSiteSettingsMediaManagerUrl:null,loadImagesUrl:null,loadFilesUrl:null,loadAudiosUrl:null,loadVideosUrl:null,insertImageDialogUrl:null,insertFileDialogUrl:null,deleteAudioUrl:null,deleteVideoUrl:null,deleteImageUrl:null,deleteFileUrl:null,getImageUrl:null,saveFolderUrl:null,renameMediaUrl:null,getMediaUrl:null,getFileUrl:null,downloadFileUrl:null,unarchiveMediaUrl:null,archiveMediaUrl:null},A={deleteImageConfirmMessage:null,deleteAudioConfirmMessage:null,deleteVideoConfirmMessage:null,deleteFileConfirmMessage:null,deleteFolderConfirmMessage:null,archiveMediaConfirmMessage:null,unarchiveMediaConfirmMessage:null,archiveVideoConfirmMessage:null,unarchiveVideoConfirmMessage:null,archiveFileConfirmMessage:null,unarchiveFileConfirmMessage:null,archiveImageConfirmMessage:null,unarchiveImageConfirmMessage:null,insertImageDialogTitle:null,insertImageFailureMessageTitle:null,insertImageFailureMessageMessage:null,imageNotSelectedMessageMessage:null,insertImageInsertButtonTitle:null,selectFolderDialogTitle:null,selectFolderFailureMessageTitle:null,selectFolderFailureMessageMessage:null,selectFolderSelectButtonTitle:null,rootFolderTitle:null,insertFileFailureMessageTitle:null,insertFileFailureMessageMessage:null,insertFileDialogTitle:null,fileNotSelectedMessageMessage:null,searchedInPathPrefix:null,noResultFoundMessage:null,imagesTabTitle:null,audiosTabTitle:null,videosTabTitle:null,filesTabTitle:null,uploadImage:null,uploadAudio:null,uploadVideo:null,uploadFile:null},K={folderViewMode:"bcms.mediaFolderViewMode"},Y={image:1,video:2,audio:3,file:4},l={customImageLeftAlign:"content-image-left",customImageRightAlign:"content-image-right"},n={file:1,folder:2},aq={ascending:0,descending:1},v={officeFiles:"|thmx|pdf|txt|doc|dot|docx|dotx|dotm|docm|xls|xlt|xlm|xlsx|xlsm|xltx|xltm|xlsb|xla|xlam|xll|xlw|ppt|pptx|pptm|potx|potm|ppam|ppsx|ppsm|sldx|sldm|csv|txt|rtf|msg|",archiveFiles:"|rar|zip|7z|tar|gz|bz2|ace|arc|arj|cab|pak|zoo|",audioFiles:"|mp3|wav|aiif|aac|flac|m4a|m4p|ogg|ra|vox|wma|",imageFiles:"|gif|bmp|ico|jpg|jpeg|png|tif|tiff|raw|psd|svg|ai|cdr|",videoFiles:"|mp4|mp2v|mp4v|mpe|mpeg|mpg|mpg2|mts|avi|3gp|mov|wmv|rm|asf|flv|flc|m2t|m2v|m4v|ogv|ogx|swf|vob|xfl|"},F=null,e=null,av=null,x=null,ar=1,m=null,E=null,w=null,g=null,t={mediaListViewModeChanged:"bcms-media-list-view-mode-changed",};O.links=M;O.globalization=A;O.events=t;function V(aA,az,ax){var aB=this;var ay=ax.find(ao.templateDataBind).get(0);var aw=az==Y.image?"Images":"Files";aB.searchQuery=L.observable();aB.includeArchived=L.observable(false);aB.includeHistoryItems=L.observable(false);aB.isFilterVisible=L.observable(false);aB.column=L.observable();aB.isDescending=L.observable(false);aB.tags=new au.TagsListViewModel();aB.categories=new j.CategoriesSelectListModel([],ay),aB.isEdited=L.computed(function(){if(aB.includeArchived()){return true;}if(aB.includeHistoryItems()){return true;}if(aB.tags!=null&&aB.tags.items()!=null&&aB.tags.items().length>0){return true;}if(aB.categories!=null&&aB.categories.items()!=null&&aB.categories.items().length>0){return true;}return false;});if(!aB.paging){aB.paging=new L.PagingViewModel(0,1,0,aA);}aB.clearFilter=function(){aB.includeArchived(false);aB.includeHistoryItems(false);aB.tags.removeAll();aB.categories.items([]);a(ay).find(ao.filterCategoriesSelect).select2("data",aB.categories.items());};aB.toggleFilter=function(){aB.isFilterVisible(!aB.isFilterVisible());};aB.closeFilter=function(){aB.isFilterVisible(false);};aB.changeIncludeArchived=function(){aB.includeArchived(!(aB.includeArchived()));};aB.changeIncludeHistoryItems=function(){aB.includeHistoryItems(!(aB.includeHistoryItems()));};aB.fromJson=function(aC){aB.searchQuery(aC.GridOptions.SearchQuery);aB.column(aC.GridOptions.Column);aB.isDescending(aC.GridOptions.Direction==aq.descending);aB.paging.setPaging(aC.GridOptions.PageSize,aC.GridOptions.PageNumber,aC.TotalCount);aB.tags.applyItemList(aC.GridOptions.Tags);aB.categories.applyItemList(aC.GridOptions.Categories);};aB.isSearchEmpty=function(){return aB.searchQuery()==null||aB.searchQuery()=="";};}function U(){var ay=this,aw=250,ax=400,aB=150,aA=150;ay.dimensions=L.observable();ay.size=L.observable();ay.imageUrl=L.observable();ay.previewUrl=L.observable();ay.imageAlt=L.observable();ay.top=L.observable();ay.left=L.observable();ay.width=L.observable();ay.height=L.observable();ay.containerWidth=L.observable();ay.containerHeight=L.observable();ay.lastX=null;ay.lastY=null;function az(aC,aD){if(!aC){aC=ay.lastX;}if(!aD){aD=ay.lastY;}if(!aC||!aD){return;}var aF=aD,aE=a(ao.previewBox).outerHeight();if(aF>a(window).height()-aw||aF>a(window).height()-aE){aF-=aE;}ay.top(aF+10+"px");ay.left(aC+10+"px");ay.lastX=aC;ay.lastY=aD;}ay.setItem=function(aD){var aE=aD.publicUrl();ay.imageUrl(aE+(aE.indexOf("?")!=-1?"&":"?")+(new Date()).getTime());ay.previewUrl(aD.thumbnailUrl());if(aD.width==-1||aD.height==-1){ay.dimensions("Auto");}else{ay.dimensions(aD.width+" x "+aD.height);}var aC=D.calculateImageDimensionsToFit(aD.width,aD.height,ax,aw);ay.containerWidth(parseInt(aC.width)+"px");ay.containerHeight(parseInt(aC.height)+"px");aC=D.calculateImageDimensionsToFit(aB,aA,aC.width,aC.height,true);ay.width(parseInt(aC.width)+"px");ay.height(parseInt(aC.height)+"px");ay.size(aD.sizeText);ay.imageAlt(aD.tooltip());};ay.onImageLoad=function(){ay.previewUrl(ay.imageUrl());ay.width("");ay.height("");az();};ay.clearItem=function(){ay.imageUrl("");ay.imageAlt("");};ay.setCoords=function(aC,aD){az(aC,aD);};return ay;}function W(aw,aC,ax){var aA=this,ay=function(aH){if(aH&&aH.Data){var aD=aA.path().currentFolder().id();var aI=aH.Data.SelectedFolderId;if(aD==aI&&aH.Data.Medias&&aH.Data.Medias.length>0){var aG=aH.Data.Medias;for(var aE=aG.length-1;aE>=0;aE--){var aF=o(aG[aE]);aA.medias.unshift(aF);f.updateFormValidator(aA.container.find(ao.firstForm));}}}},az;aA.container=aw;aA.messagesContainer=ax;aA.url=aC;aA.onMediaSelect=null;aA.medias=L.observableArray();aA.path=L.observable();aA.isGrid=L.observable(at.get(K.folderViewMode)==1);aA.canSelectMedia=L.observable(false);aA.canInsertMedia=L.observable(false);aA.canInsertMediaWithOptions=L.observable(false);aA.canSearchInHistory=L.observable(false);aA.searchEnabled=L.observable(false);aA.hasFocus=L.observable(false);aA.showPropertiesPreview=L.observable(false);aA.previewItem=new U();aA.rowAdded=false;aA.gridOptions=L.observable();aA.isRootFolder=function(){if(aA.path!=null&&aA.path().folders!=null&&aA.path().folders().length>1){return false;}return true;};aA.showNoDataInfoDiv=function(){return((aA.isRootFolder()||aA.isSearchResults())&&aA.medias().length==0);};aA.isSearchResults=L.observable(false);aA.noSearchResultFound=L.observable("");aA.addNewFolder=function(){if(!aA.rowAdded){aA.rowAdded=true;var aD=new R({IsActive:true,Type:aA.path().currentFolder().type,ParentFolderId:aA.path().currentFolder().id()});aA.medias.unshift(aD);f.updateFormValidator(aA.container.find(ao.firstForm));}};aA.toggleMenu=function(aI,aG){var aH,aK=aI.isMenuOpen(),aE=a(aG.target),aJ=aE.siblings(),aF=aE.scrollParent(),aL;for(aH=0;aH<aA.medias().length;aH++){aA.medias()[aH].isMenuOpen(false);}if(!aK){aL=aF.height()+aF.offset().top-aE.offset().top-aE.outerHeight(true);if(aL<aJ.outerHeight(true)){var aD=aE.outerHeight(true)+parseInt(aE.parent().css("padding-bottom"));aJ.css({bottom:aD});aI.isMenuAbove(true);}else{aJ.css({bottom:""});aI.isMenuAbove(false);}}aI.isMenuOpen(!aK);f.stopEventPropagation(aG);};aA.uploadMedia=function(){Z.openUploadFilesDialog(aA.path().currentFolder().id(),aA.path().currentFolder().type,ay);ac.refreshBox(a(ao.fileListMessageBox+aA.path().type),{});};aA.reuploadMedia=function(aD){if(aD.isProcessing()||aD.isDeleting()){return;}Z.openReuploadFilesDialog(aD.id(),aA.path().currentFolder().id(),aA.path().currentFolder().type,function(aE){if(aE&&aE.Data&&aE.Data.Medias&&aE.Data.Medias.length>0){var aG=o(aE.Data.Medias[0]);if(aA.path().currentFolder().type==Y.file){aG.thumbnailUrl(aD.thumbnailUrl());aG.tooltip(aD.tooltip());}var aF=a.inArray(aD,aA.medias());aA.medias.splice(aF,1,aG);f.updateFormValidator(aA.container.find(ao.firstForm));}});ac.refreshBox(a(ao.fileListMessageBox+aA.path().type),{});};aA.searchMedia=function(){aA.gridOptions().paging.pageNumber(1);aA.loadMedia();};aA.toggleSearch=function(){if(!aA.searchEnabled()){aA.searchEnabled(true);aA.hasFocus(true);}else{aA.searchEnabled(false);aA.gridOptions().searchQuery("");}};aA.searchWithFilter=function(aD){if(aD===true){aA.gridOptions().includeHistoryItems(true);}else{if(aD===false){aA.gridOptions().includeHistoryItems(false);}}aA.searchMedia();};aA.clearFilter=function(){aA.gridOptions().clearFilter();aA.searchMedia();};aA.onOpenPage=function(){aA.loadMedia();};aA.sortMedia=function(aD){var aE=aA.gridOptions().column(),aH=aA.gridOptions().isDescending();if(aE==aD){aA.gridOptions().isDescending(!aH);}else{aA.gridOptions().isDescending(false);}aA.gridOptions().column(aD);var aG=p(aA.path().currentFolder().id(),aA),aF=function(aI){ak(aI,aA);};N(aA,aG,aF);};aA.switchViewStyle=function(){var aD=!aA.isGrid();at.set(K.folderViewMode,aD?1:0);f.trigger(O.events.mediaListViewModeChanged,aD);};aA.isSortedAscending=function(aD){if(aD==aA.gridOptions().column()&&!aA.gridOptions().isDescending()){return true;}return false;};aA.isSortedDescending=function(aD){if(aD==aA.gridOptions().column()&&aA.gridOptions().isDescending()){return true;}return false;};aA.uploadButtonTitle=function(){switch(aA.path().type){case Y.image:return A.uploadImage;case Y.audio:return A.uploadAudio;case Y.video:return A.uploadVideo;case Y.file:return A.uploadFile;}return null;};aA.openRoot=function(){k(null,aA);};aA.openParent=function(){k(aA.path().currentFolder().parentFolderId(),aA);};aA.domId=function(){return"bcms-site-settings-media-messages-"+aA.path().type;};aA.loadMedia=function(){var aE=p(aA.path().currentFolder().id(),aA),aD=function(aF){ak(aF,aA);a(ao.searchBox).focus();};N(aA,aE,aD);};aA.unselectAllMedias=function(aF){var aE,aD,aG;for(aD=0,aG=aA.medias().length;aD<aG;aD++){aE=aA.medias()[aD];aE.isSelected(aE==aF);}};aA.movePreview=function(aF,aG){var aH=aA.showPropertiesPreview(),aD=aG.clientX,aE=aG.clientY;if(ab.isVisible||!aF.isImage()){if(aH){aA.showPropertiesPreview(false);}return;}if(!aH){if(az!=null){clearTimeout(az);}az=setTimeout(function(){aB(aF,aD,aE);},300);}else{aA.previewItem.setCoords(aD,aE);}};aA.isImage=function(){if(aA.path().type==Y.image){return true;}return false;};function aB(aF,aD,aE){if(ab.isVisible||!aF.isImage()){return;}aA.previewItem.setItem(aF);aA.previewItem.setCoords(aD,aE);aA.showPropertiesPreview(true);}aA.hidePreview=function(){if(az!=null){clearTimeout(az);}aA.showPropertiesPreview(false);aA.previewItem.clearItem();};f.on(O.events.mediaListViewModeChanged,function(aD){aA.isGrid(aD);});}function X(ax){var aw=this;aw.isSearchResults=L.observable(false);aw.currentFolder=L.observable();aw.folders=L.observableArray();aw.type=ax;aw.pathFolders=L.computed(function(){var az=aw.folders(),ay=aw.isSearchResults()?A.searchedInPathPrefix+" ":"";if(az.length>0){switch(aw.type){case Y.image:az[0].name(ay+A.imagesTabTitle);break;case Y.audio:az[0].name(ay+A.audiosTabTitle);break;case Y.video:az[0].name(ay+A.videosTabTitle);break;case Y.file:az[0].name(ay+A.filesTabTitle);break;}}return az;});}var T=(function(){function aw(ax){var ay=this;ay.id=L.observable(ax.Id);ay.name=L.observable(ax.Name);ay.oldName=ax.Name;ay.version=L.observable(ax.Version);ay.publicUrl=L.observable(ax.PublicUrl);ay.extension=ax.FileExtension;ay.type=ax.Type;ay.nameDomId="name_"+ar++;ay.updateUrl=M.renameMediaUrl;ay.isProcessing=L.observable(ax.IsProcessing||false);ay.isFailed=L.observable(ax.IsFailed||false);ay.savePressed=false;ay.isArchived=L.observable(ax.IsArchived);ay.isActive=L.observable(ax.IsActive||false);ay.isSelected=L.observable(false);ay.isDeleting=L.observable(false);ay.parentFolderId=L.observable(ax.ParentFolderId);ay.parentFolderName=L.observable(ax.ParentFolderName);ay.tooltip=L.observable(ax.Tooltip);ay.thumbnailUrl=L.observable(ax.ThumbnailUrl);ay.isReadOnly=L.observable(ax.IsReadOnly);ay.isMenuOpen=L.observable(false);ay.isMenuAbove=L.observable(false);ay.getImageUrl=function(){if(!ay.publicUrl()){return null;}return ay.publicUrl();};ay.getImageThumbnailUrl=function(){if(!ay.thumbnailUrl()){return null;}return ay.thumbnailUrl();};f.on(f.events.bodyClick,function(az){if(a(az.srcElement).closest(".bcms-media-context").length>0){f.stopEventPropagation(az);}else{ay.isMenuOpen(false);}});ay.isFile=function(){return !ay.isFolder();};ay.canBeDownloaded=function(){return !!ay.publicUrl();};ay.stopEvent=function(az,aA){f.stopEventPropagation(aA);};ay.downloadMedia=function(){window.open(a.format(M.downloadFileUrl,ay.id()),"_newtab");ay.isMenuOpen(false);};ay.rowClassNames=L.computed(function(){var az="";if(ay.isFolder()){az+=" bcms-folder-box";if(ay.isActive()){az+=" bcms-folder-box-active";}}if(ay.isFile()&&!ay.isImage()){az+=" bcms-file-box";}if(ay.isImage()){az+=" bcms-image-box";}if(ay.isFile()&&ay.isActive()){if(!ay.isImage()){az+=" bcms-file-box-active";}else{az+=" bcms-image-box-active";}}if(ay.isSelected()){az+=" bcms-media-click-active";}return a.trim(az);});ay.iconClassNames=L.computed(function(){var az="";if(ay.isFolder()){az+=" bcms-media-folder";}if(ay.isImage()){az+=" bcms-media-file-holder";}if(ay.isFile()&&!ay.isImage()){az+=" bcms-system-file";}if(!ay.isImage()&&ay.extension){az+=z(ay.extension);}return a.trim(az);});ay.archiveMedia=function(aB,az,aA){f.stopEventPropagation(aA);var aD=a.format(M.archiveMediaUrl,this.id(),this.version()),aC=a.format(ay.getArchiveMediaConfirmationMessage(),this.name());d(true,aD,aC,aB,this);ay.isMenuOpen(false);};ay.unarchiveMedia=function(aB,az,aA){f.stopEventPropagation(aA);var aD=a.format(M.unarchiveMediaUrl,this.id(),this.version()),aC=a.format(ay.getUnarchiveMediaConfirmationMessage(),this.name());d(false,aD,aC,aB,this);ay.isMenuOpen(false);};ay.showParentLink=function(aA,az){return aA.isSearchResults();};ay.openParent=function(aA,az){k(ay.parentFolderId(),aA);};ay.selectThis=function(aA,az){a(az).select();};}aw.prototype.isFolder=function(){return false;};aw.prototype.isImage=function(){return false;};aw.prototype.deleteMedia=function(ax){throw new Error("Delete method is not implemented.");};aw.prototype.getArchiveMediaConfirmationMessage=function(){return A.archiveMediaConfirmMessage;};aw.prototype.getUnarchiveMediaConfirmationMessage=function(){return A.unarchiveMediaConfirmMessage;};aw.prototype.editMedia=function(az,ax,ay){f.stopEventPropagation(ay);if(this.isDeleting()){return;}this.renameMedia(az,ax,ay);};aw.prototype.renameMedia=function(az,ax,ay){f.stopEventPropagation(ay);if(this.isDeleting()){return;}this.isActive(true);this.isMenuOpen(false);};aw.prototype.reuploadMedia=function(az,ax,ay){f.stopEventPropagation(ay);if(this.isDeleting()){return;}az.reuploadMedia(this);this.isMenuOpen(false);};aw.prototype.openMedia=function(az,ax,ay){f.stopEventPropagation(ay);s(az,this,ax,ay);ac.refreshBox(a(ao.fileListMessageBox+this.type),{});};aw.prototype.onIconClicked=function(az,ax,ay){this.openMedia(az,ax,ay);};aw.prototype.onTitleClicked=function(az,ax,ay){this.openMedia(az,ax,ay);};aw.prototype.saveMedia=function(az,ax,ay){f.stopEventPropagation(ay);this.savePressed=true;al(az,this);};aw.prototype.blurMediaField=function(ax){i(ax,this);};aw.prototype.insertMedia=function(ax){throw new Error("Insert media method is not implemented.");};aw.prototype.insertMediaWithOptions=function(ax){throw new Error("Insert media with options method is not implemented.");};aw.prototype.cancelEditMedia=function(az,ax,ay){f.stopEventPropagation(ay);h(az,this);};aw.prototype.toJson=function(){var ax={Id:this.id(),Name:this.name(),Version:this.version(),Type:this.type};return ax;};aw.prototype.showHistory=function(az,ax,ay){f.stopEventPropagation(ay);if(this.isDeleting()){return;}B.openMediaHistoryDialog(this.id(),az.isImage(),function(){az.searchMedia();});};return aw;})();var S=(function(aw){f.extendsClass(ax,aw);function ax(ay){aw.call(this,ay);var az=this;az.width=ay.Width;az.height=ay.Height;az.sizeText=ay.SizeText;az.previewImage=function(){az.isMenuOpen(false);var aA=az.publicUrl();if(aA){ad.imagePreview(aA,az.tooltip);}};}ax.prototype.isImage=function(){return true;};ax.prototype.deleteMedia=function(aA,ay,az){f.stopEventPropagation(az);var aC=a.format(M.deleteImageUrl,this.id(),this.version()),aB=a.format(A.deleteImageConfirmMessage,this.name());q(aC,aB,aA,this);this.isMenuOpen(false);};ax.prototype.getArchiveMediaConfirmationMessage=function(){this.isMenuOpen(false);return A.archiveImageConfirmMessage;};ax.prototype.getUnarchiveMediaConfirmationMessage=function(){this.isMenuOpen(false);return A.unarchiveImageConfirmMessage;};ax.prototype.editMedia=function(aA,ay,az){f.stopEventPropagation(az);if(this.isDeleting()){return;}if(am.IsAuthorized(["BcmsEditContent"])){var aB=this;D.onEditImage(aB.id(),function(aC){aB.version(aC.Version);aB.tooltip(aC.Caption||aC.Tooltip);aB.thumbnailUrl(aC.ThumbnailUrl);aB.publicUrl(aC.Url||aC.PublicUrl);aB.name(aC.Title||aC.Name);aB.oldName=aC.Title||aC.Name;aB.sizeText=aC.FileSize||aC.SizeText;aB.width=aC.CroppedWidth||aC.Width;aB.height=aC.CroppedHeight||aC.Height;});}};ax.prototype.insertMedia=function(aA,ay,az){f.stopEventPropagation(az);J(this,false,aA.onMediaSelect);};ax.prototype.insertMediaWithOptions=function(aA,ay,az){f.stopEventPropagation(az);J(this,true,aA.onMediaSelect);};return ax;})(T);var P=(function(aw){f.extendsClass(ax,aw);function ax(ay){aw.call(this,ay);}ax.prototype.deleteMedia=function(aA,ay,az){f.stopEventPropagation(az);var aC=a.format(M.deleteAudioUrl,this.id(),this.version()),aB=a.format(A.deleteAudioConfirmMessage,this.name());q(aC,aB,aA,this);};return ax;})(T);var aa=(function(aw){f.extendsClass(ax,aw);function ax(ay){aw.call(this,ay);}ax.prototype.deleteMedia=function(aA,ay,az){f.stopEventPropagation(az);var aC=a.format(M.deleteVideoUrl,this.id(),this.version()),aB=a.format(A.deleteVideoConfirmMessage,this.name());q(aC,aB,aA,this);};ax.prototype.getArchiveMediaConfirmationMessage=function(){return A.archiveVideoConfirmMessage;};ax.prototype.getUnarchiveMediaConfirmationMessage=function(){return A.unarchiveVideoConfirmMessage;};return ax;})(T);var Q=(function(aw){f.extendsClass(ax,aw);function ax(ay){aw.call(this,ay);}ax.prototype.deleteMedia=function(aA,ay,az){f.stopEventPropagation(az);var aC=a.format(M.deleteFileUrl,this.id(),this.version()),aB=a.format(A.deleteFileConfirmMessage,this.name());q(aC,aB,aA,this);};ax.prototype.insertMedia=function(aA,ay,az){f.stopEventPropagation(az);I(this);};ax.prototype.editMedia=function(aA,ay,az){f.stopEventPropagation(az);if(this.isDeleting()){return;}if(am.IsAuthorized(["BcmsEditContent"])){var aB=this;u.onEditFile(aB.id(),function(aC){aB.version(aC.Version);aB.name(aC.Title||aC.Name);aB.oldName=aC.Title||aC.Name;if(aC.Image){aB.tooltip(aC.Image.ImageTooltip);aB.thumbnailUrl(aC.Image.ThumbnailUrl);}else{aB.thumbnailUrl(aC.ThumbnailUrl);aB.tooltip(aC.Tooltip);}});}};ax.prototype.getArchiveMediaConfirmationMessage=function(){return A.archiveFileConfirmMessage;};ax.prototype.getUnarchiveMediaConfirmationMessage=function(){return A.unarchiveFileConfirmMessage;};return ax;})(T);var R=(function(aw){f.extendsClass(ax,aw);function ax(ay){aw.call(this,ay);var az=this;az.updateUrl=M.saveFolderUrl;az.pathName=L.computed(function(){return az.name()+" / ";});}ax.prototype.isFolder=function(){return true;};ax.prototype.deleteMedia=function(aA,ay,az){f.stopEventPropagation(az);var aC=a.format(M.deleteFolderUrl,this.id(),this.version()),aB=a.format(A.deleteFolderConfirmMessage,this.name());q(aC,aB,aA,this);};ax.prototype.openMedia=function(aA,ay,az){f.stopEventPropagation(az);if(this.isDeleting()){return;}k(this.id(),aA);};ax.prototype.toJson=function(){var ay={Id:this.id(),Name:this.name(),Version:this.version(),Type:this.type,ParentFolderId:this.parentFolderId()};return ay;};return ax;})(T);function an(aw,aA){var ax,az,ay;if(!aA||f.isEmptyGuid(aA)){return;}for(ax=0,az=aw.medias().length;ax<az;ax++){ay=aw.medias()[ax];if(ay.id()==aA){ay.isSelected(true);}}}function s(ay,az,aw,ax){if(az.isProcessing()||az.isFailed()||az.isDeleting()){return;}if(!ay.canSelectMedia()){az.editMedia(ay,aw,ax);return;}ay.unselectAllMedias(az);}function i(aw,ax){if(!ax.isActive()){return;}g=setTimeout(function(){if(!ax.name()&&!ax.id()){h(aw,ax);}else{al(aw,ax);}},500);}function h(aw,az){az.isActive(false);aw.rowAdded=false;if(!az.id()){aw.medias.remove(az);}else{az.name(az.oldName);var ax="#"+az.nameDomId,ay=aw.container.find(ax);ay.valid();}}function al(aw,az){if(az.isDeleting()){return;}var ax="#"+az.nameDomId,ay=aw.container.find(ax),aA=a(ay.closest(ap.selectors.loaderContainer).get(0)||ay.closest(ad.selectors.scrollWindow).get(0));clearTimeout(g);aw.rowAdded=false;if(az.savePressed||(az.oldName!=az.name()&&az.isActive())){if(ay.valid()){var aC=az.toJson(),aB=function(aD){aA.hideLoading();ac.refreshBox(aw.container,aD);if(aD.Success&&aD.Data){az.version(aD.Data.Version);az.id(aD.Data.Id);az.oldName=az.name();az.isActive(false);}else{az.isActive(true);}};aA.showLoading();az.isActive(false);a.ajax({url:az.updateUrl,type:"POST",dataType:"json",cache:false,data:aC}).done(function(aD){aB(aD);}).fail(function(aD){aB(f.parseFailedResponse(aD));});}else{if(az.savePressed){ay.focus();}}}else{az.isActive(false);}az.savePressed=false;}function z(aw){aw=aw.toLowerCase();if(!aw){return" bcms-uknown-icn";}if(aw.indexOf(".")===0){aw=aw.substring(1,aw.length);}aw=a.format("|{0}|",aw);if(v.archiveFiles.indexOf(aw)>=0){return" bcms-archive-icn";}if(v.audioFiles.indexOf(aw)>=0){return" bcms-audio-icn";}if(v.videoFiles.indexOf(aw)>=0){return" bcms-video-icn";}if(v.imageFiles.indexOf(aw)>=0){return" bcms-image-icn";}if(v.officeFiles.indexOf(aw)>=0){return" bcms-office-icn";}return" bcms-uknown-icn";}O.loadSiteSettingsMediaManager=function(){r.bindSiteSettings(ap,M.loadSiteSettingsMediaManagerUrl,{contentAvailable:G});};O.openFolderSelectDialog=function(ax){var aw=a.extend({onAccept:function(){},folderViewModelOptions:null,onClose:null,parentFolderId:"",},ax);ad.open({title:A.selectFolderDialogTitle,acceptTitle:A.selectFolderSelectButtonTitle,onClose:aw.onClose,onLoad:function(ay){r.setContentFromUrl(ay,a.format(M.insertImageDialogUrl,aw.parentFolderId||""),{done:function(az){F=new W(ay.container,M.loadImagesUrl,ay.container);F.spinContainer=ay.container.find(ao.insertContentContainer);if(aw.folderViewModelOptions){F=a.extend(F,aw.folderViewModelOptions);}F.selectFolder=function(aA){ay.close();aw.onAccept(aA);};H(az,F);}});},onAcceptClick:function(){if(a.isFunction(aw.onAccept)){aw.onAccept(F.path().currentFolder());}return true;}});};O.openImageInsertDialog=function(ax){var aw=a.extend({onAccept:function(){},canInsertWithOptions:false,folderViewModelOptions:null,onClose:null,currentFolder:"",selectedId:""},ax);ad.open({title:A.insertImageDialogTitle,acceptTitle:A.insertImageInsertButtonTitle,onClose:aw.onClose,onLoad:function(ay){E=ay;r.setContentFromUrl(ay,a.format(M.insertImageDialogUrl,aw.currentFolder||""),{done:function(az){F=new W(ay.container,M.loadImagesUrl,ay.container);F.canSelectMedia(true);F.canInsertMedia(true);F.canInsertMediaWithOptions(aw.canInsertWithOptions);F.spinContainer=ay.container.find(ao.insertContentContainer);if(aw.folderViewModelOptions){F=a.extend(F,aw.folderViewModelOptions);}H(az,F);an(F,aw.selectedId);}});},onAcceptClick:function(){var ay,az,aA=null;for(ay=0;ay<F.medias().length;ay++){az=F.medias()[ay];if(az.isSelected()&&az.type==Y.image){aA=az;break;}}if(aA==null){ad.info({content:A.imageNotSelectedMessageMessage,disableCancel:true});return false;}else{if(a.isFunction(aw.onAccept)){aw.onAccept(aA);}}return true;}});};function ah(aw){m=aw;var ax={onAccept:function(ay){J(ay,false);},canInsertWithOptions:true};O.openImageInsertDialog(ax);}function J(aA,aC,az){if(aA.isDeleting()){return;}var ay=aA.id(),aw=function(){ad.alert({title:A.insertImageFailureMessageTitle,content:A.insertImageFailureMessageMessage});},ax=function(aF,aG,aE,aD){if(a.isFunction(az)){az(aF,aG,aE,aD);}else{c(aG,aE,aD,aF.version());}if(E!=null){E.close();E=null;}};if(aC===true){D.onInsertImage(aA,ax);}else{var aB=a.format(M.getImageUrl,ay);a.ajax({url:aB,type:"POST",dataType:"json"}).done(function(aD){if(aD.Success&&aD.Data!=null){ax(aA,aD.Data.Url,aD.Data.Caption,aD.Data.ImageAlign);}else{aw();}}).fail(function(){aw();});}}function c(aA,ax,az,aC){ax=ax||"";if(m!=null){var aw="left",ay=l.customImageLeftAlign,aB;if(az==2){aw="";ay="";}else{if(az==3){ay=l.customImageRightAlign,aw="right";}}if(m.codeEditorMode){aB=aA;}else{if(az==2){aB='<img src="'+aA+'" alt="'+ax+'"/>';}else{aB='<img src="'+aA+'" alt="'+ax+'" style="float:'+aw+'" class="'+ay+'" />';}}m.addHtml(aB,{src:aA,alt:ax,imageAlign:aw});}}O.openFileInsertDialog=function(aw){ad.open({title:A.insertFileDialogTitle,acceptTitle:"Insert",onLoad:function(ax){w=ax;r.setContentFromUrl(ax,M.insertFileDialogUrl,{done:function(ay){x=new W(ax.container,M.loadFilesUrl,ax.container);x.canSelectMedia(true);x.canInsertMedia(true);x.spinContainer=ax.container.find(ao.insertContentContainer);H(ay,x);}});},onAcceptClick:function(){var ax,ay,az=null;for(ax=0;ax<x.medias().length;ax++){ay=x.medias()[ax];if(ay.isSelected()&&ay.type==Y.file){az=ay;break;}}if(az==null){ad.info({content:A.fileNotSelectedMessageMessage,disableCancel:true});return false;}else{if(a.isFunction(aw)){aw(az);}}return true;}});};function I(aw){b(window.location.origin+a.format(M.getFileUrl,aw.id()),aw.name());if(w!=null){w.close();w=null;}}function ag(aw){m=aw;O.openFileInsertDialog(function(ax){I(ax);});}function b(ay,ax){if(m!=null){var aw;if(m.codeEditorMode){aw=ay;}else{aw='<a href="'+ay+'">'+ax+"</a>";}m.addHtml(aw,{href:ay,html:ax});}}function q(aB,az,ax,ay){if(ay.isProcessing()||ay.isDeleting()){return;}var aA=function(aC){ac.refreshBox(ax.container,aC);if(aC.Success){ax.medias.remove(ay);}else{ay.isDeleting(false);}aw.close();},aw=ad.confirm({content:az,onAccept:function(){ay.isDeleting(true);a.ajax({type:"POST",url:aB,contentType:"application/json; charset=utf-8",dataType:"json",cache:false}).done(function(aC){aA(aC);}).fail(function(aC){aA(f.parseFailedResponse(aC));});}});}function d(ay,aC,aA,ax,az){if(az.isDeleting()){return;}var aB=function(aD){ac.refreshBox(ax.container,aD);if(aD.Success){az.isArchived(ay);if(aD.Data&&aD.Data.Version){az.version(aD.Data.Version);}if(ay&&!ax.gridOptions().includeArchived()){ax.medias.remove(az);}}aw.close();},aw=ad.confirm({content:aA,onAccept:function(){a.ajax({type:"POST",url:aC,contentType:"application/json; charset=utf-8",dataType:"json",cache:false}).done(function(aD){aB(aD);}).fail(function(aD){aB(f.parseFailedResponse(aD));});}});}function p(aw,ax){var az={CurrentFolderId:aw};if(ax!=null&&ax.gridOptions()!=null){var aA=ax.gridOptions().searchQuery();if(aA){az.SearchQuery=aA;}az.Column=ax.gridOptions().column();az.Direction=ax.gridOptions().isDescending()?aq.descending:aq.ascending;az.PageSize=ax.gridOptions().paging.pageSize;az.PageNumber=ax.gridOptions().paging.pageNumber();az.IncludeArchivedItems=ax.gridOptions().includeArchived();az.SearchInHistory=ax.gridOptions().includeHistoryItems();if(ax.gridOptions().tags.items().length>0){az.Tags=[];for(var ay=0;ay<ax.gridOptions().tags.items().length;ay++){az.Tags.push({Key:ax.gridOptions().tags.items()[ay].id(),Value:ax.gridOptions().tags.items()[ay].name()});}}if(ax.gridOptions().categories.items().length>0){az.Categories=[];for(var ay=0;ay<ax.gridOptions().categories.items().length;ay++){az.Categories.push({Key:ax.gridOptions().categories.items()[ay].id,Value:ax.gridOptions().categories.items()[ay].text});}}}return az;}function k(ax,aw){if(aw!=null&&aw.gridOptions()!=null){aw.gridOptions().searchQuery("");aw.gridOptions().closeFilter();}var az=p(ax,aw),ay=function(aA){ac.refreshBox(aw.container,{});ak(aA,aw);};N(aw,az,ay);}function ak(aB,ax){var ay,az;ac.refreshBox(ax.container,aB);if(aB.Success){ax.medias.removeAll();if(aB.Data){if(aB.Data.Path){var aE=new X(aB.Data.Path.CurrentFolder.Type);if(aB.Data.Path.CurrentFolder){var aw=new R(aB.Data.Path.CurrentFolder);aE.currentFolder(aw);}if(aB.Data.Path.Folders&&a.isArray(aB.Data.Path.Folders)){for(ay=0;ay<aB.Data.Path.Folders.length;ay++){var aD=new R(aB.Data.Path.Folders[ay]);aE.folders.push(aD);}}ax.path(aE);}if(aB.Data.Items&&aB.Data.Items&&a.isArray(aB.Data.Items)){for(ay=0;ay<aB.Data.Items.length;ay++){var aA=aB.Data.Items[ay],aC=o(aA);if(aC!=null){ax.medias.push(aC);}}}if(!ax.gridOptions()){ax.gridOptions(new V(ax.onOpenPage,aB.Data.Path.CurrentFolder.Type,ax.container));}ax.gridOptions().fromJson(aB.Data);az=!ax.gridOptions().isSearchEmpty();ax.isSearchResults(az);ax.path().isSearchResults(az);if(az){ax.noSearchResultFound(a.format(A.noResultFoundMessage,ax.gridOptions().searchQuery()));}else{ax.noSearchResultFound("");}ax.canSearchInHistory(!ax.searchInHistory&&!ax.gridOptions().includeHistoryItems());ax.searchInHistory=false;f.updateFormValidator(ax.container.find(ao.firstForm));}return true;}return false;}function o(aw){var ax;if(aw.ContentType==n.folder){ax=new R(aw);}else{switch(aw.Type){case Y.image:ax=new S(aw);break;case Y.audio:ax=new P(aw);break;case Y.video:ax=new aa(aw);break;case Y.file:ax=new Q(aw);break;default:ax=null;break;}}return ax;}function N(ax,aA,aw){var ay="mediatab",aB=ax.spinContainer,az=function(aC){aB.hideLoading(ay);if(a.isFunction(aw)){aw(aC);}};aB.showLoading(ay);a.ajax({type:"POST",contentType:"application/json; charset=utf-8",dataType:"json",cache:false,url:ax.url,data:JSON.stringify(aA)}).done(function(aC){az(aC);}).fail(function(aC){az(f.parseFailedResponse(aC));});}function H(ay,ax){var aw=ax.container.find(ao.templateDataBind).get(0);if(ak(ay,ax)){L.applyBindings(ax,aw);j.initCategoriesSelect(ax.gridOptions().categories,ay.Data.CategoriesLookupList,aw);f.updateFormValidator(ax.container.find(ao.firstForm));}}function G(aw){x=null;e=null;av=null;var ax=ap.getModalDialog().container,az=function(){var aA=ax.find("input[type=text],textarea,select").filter(":visible:first");if(aA){aA.focus();}};ax.find(ao.tabFilesSelector).on("click",function(){var aA=ax.find(ao.tabFilesContainer);ax.find(ao.filesTabMessageBoxCloseButton).on("click",function(){ax.find(ao.filesTabMessageBox).hide();});if(x==null){x=new W(aA,M.loadFilesUrl,ax);x.spinContainer=aA.parents(ao.spinContainer);N(x,null,function(aB){H(aB,x);az();});}else{az();}});ax.find(ao.tabImagesSelector).on("click",function(){az();});var ay=ax.find(ao.tabImagesContainer);F=new W(ay,M.loadImagesUrl,ax);F.spinContainer=ay.parents(ao.spinContainer);H(aw,F);az();}O.ImageSelectorViewModel=(function(){O.ImageSelectorViewModel=function(aw){var ax=this;ax.id=L.observable();ax.url=L.observable();ax.thumbnailUrl=L.observable();ax.tooltip=L.observable();ax.version=L.observable();ax.currentFolder=L.observable();ax.setImage=function(ay){ax.thumbnailUrl(ay.ThumbnailUrl);ax.url(ay.ImageUrl);ax.tooltip(ay.ImageTooltip);ax.id(ay.ImageId);ax.version(ay.ImageVersion);ax.currentFolder(ay.FolderId);};if(aw){ax.setImage(aw);}};O.ImageSelectorViewModel.prototype.preview=function(aw,ax){f.stopEventPropagation(ax);var az=this.url(),aA=this;if(az){var ay={onClose:function(){aA.onAfterPreview();}};ad.imagePreview(az,this.tooltip(),ay);}};O.ImageSelectorViewModel.prototype.remove=function(aw,ax){f.stopEventPropagation(ax);this.setImage({});this.onAfterRemove();};O.ImageSelectorViewModel.prototype.select=function(aw,ax){var aC=this,az=function(aD){aC.thumbnailUrl(aD.thumbnailUrl());aC.url(aD.publicUrl());aC.tooltip(aD.tooltip);aC.id(aD.id());aC.version(aD.version());aC.currentFolder(aD.parentFolderId());aC.onAfterSelect();},ay={onMediaSelect:function(aD){az(aD);}},aA=function(){aC.onSelectClose();},aB={onAccept:az,canInsertWithOptions:false,folderViewModelOptions:ay,onClose:aA,currentFolder:aC.currentFolder(),selectedId:aC.id()};f.stopEventPropagation(ax);O.openImageInsertDialog(aB);};O.ImageSelectorViewModel.prototype.onAfterSelect=function(){};O.ImageSelectorViewModel.prototype.onAfterRemove=function(){};O.ImageSelectorViewModel.prototype.onAfterPreview=function(){};O.ImageSelectorViewModel.prototype.onSelectClose=function(){};return O.ImageSelectorViewModel;})();O.ImageFolderSelectorViewModel=(function(){O.ImageFolderSelectorViewModel=function(aw){var ax=this;ax.id=L.observable();ax.title=L.observable();ax.parentFolderId=L.observable();ax.setFolder=function(ay){ax.id(ay.FolderId);ax.title(ay.FolderTitle);ax.parentFolderId(ay.ParentFolderId);};if(aw){ax.setFolder(aw);}};O.ImageFolderSelectorViewModel.prototype.select=function(aw,ax){var aD=this,az=function(aE){aD.id(aE.id());aD.title(aE.name());aD.parentFolderId(aE.parentFolderId());aD.onAfterSelect();},ay={onMediaSelect:function(aE){az(aE);}},aA=function(){aD.onSelectClose();},aC=aD.parentFolderId(),aB={onAccept:az,folderViewModelOptions:ay,onClose:aA,parentFolderId:!aC||f.isEmptyGuid(aC)?"":aC};f.stopEventPropagation(ax);O.openFolderSelectDialog(aB);};O.ImageFolderSelectorViewModel.prototype.onAfterSelect=function(){};O.ImageFolderSelectorViewModel.prototype.onSelectClose=function(){};return O.ImageFolderSelectorViewModel;})();function ae(aC,aB,aw){var az=function(aF){var aD=aF.id(),aE=aF.name();if(!aD||f.isEmptyGuid(aD)){aD="";aE=A.rootFolderTitle;}aC(aD);aB(aE);aw();},ay=function(){aw();},ax={onMediaSelect:function(aD){az(aD);}},aA={onAccept:az,onClose:ay,folderViewModelOptions:ax,parentFolderId:aC()};O.openFolderSelectDialog(aA);}function af(aB,aA,aw){var ay=function(aC){var aD=aC.getImageUrl();aB(aD);aA(aD);aw();},ax=function(){aw();},az={onAccept:ay,onClose:ax,};O.openImageInsertDialog(az);}function ai(){if(F&&a.isFunction(F.showPropertiesPreview)){F.showPropertiesPreview(false);}}O.init=function(){f.logger.debug("Initializing bcms.media module.");f.on(C.events.insertImage,ah);f.on(C.events.insertFile,ag);f.on(ab.events.menuOn,ai);u.SetMedia(O);aj.registerCustomOption("media-images-folder",ae);aj.registerCustomOption("media-images-url",af);};f.registerInit(O.init);return O;});bettercms.define("bcms.media.upload",["bcms.jquery","bcms","bcms.dynamicContent","bcms.modal","bcms.html5Upload","bcms.ko.extenders","bcms.messages","bcms.security"],function(a,b,e,q,k,m,p,r){var o={},s={dragZone:"#bcms-files-drop-zone",messageBox:"#bcms-multi-file-upload-messages",fileUploadingContext:"#bcms-media-uploads",fileUploadingMasterForm:"#SaveForm",fileUploadingForm:"#ImgForm",fileUploadingTarget:"#UploadTarget",fileUploadingInput:"#uploadFile",fileUploadingResult:"#jsonResult",folderDropDown:"#SelectedFolderId",uploadButtonLabel:".bcms-btn-upload-files-text",userAccessControlContainer:"#bcms-accesscontrol-context",overrideSelect:"bcms-media-reupload-override"},c={dragZoneActive:"bcms-file-drop-zone-active"},n={loadUploadFilesDialogUrl:null,uploadFileToServerUrl:null,undoFileUploadUrl:null,loadUploadSingleFileDialogUrl:null,checkUploadedFileStatuses:null},j={uploadFilesDialogTitle:null,failedToProcessFile:null,multipleFilesWarningMessageOnReupload:null},d={defaultReuploadMediaId:"00000000-0000-0000-0000-000000000000"},f=k.fileApiSupported();o.links=n;o.globalization=j;o.openUploadFilesDialog=function(A,B,x,z,w){z=z||d.defaultReuploadMediaId;var y={uploads:new v(),rootFolderId:A,rootFolderType:B,reuploadMediaId:z};y.uploads.filesToAccept(B==1?"image/*":"");if(f){q.open({title:j.uploadFilesDialogTitle,onLoad:function(C){var D=a.format(n.loadUploadFilesDialogUrl,A,B,z);e.bindDialog(C,D,{contentAvailable:function(G,E){l(C,y);var F=C.container.find(s.userAccessControlContainer).get(0);if(F){var H={accessControl:r.createUserAccessViewModel(E.Data.UserAccessList)};m.applyBindings(H,F);}},beforePost:function(){C.container.showLoading();},postSuccess:function(E){y.uploads.stopStatusChecking();y.uploads.removeFailedUploads();if(x&&a.isFunction(x)){x(E);}},postComplete:function(){C.container.hideLoading();},postError:function(){y.uploads.filesToAccept(B==1?"image/*":"");}});},onCloseClick:function(){y.uploads.removeAllUploads();y.uploads.stopStatusChecking();if(w&&a.isFunction(w)){w();}},onAcceptClick:function(){y.uploads.filesToAccept("");}});}else{q.open({title:j.uploadFilesDialogTitle,onLoad:function(C){var D=a.format(n.loadUploadSingleFileDialogUrl,A,B,z);e.setContentFromUrl(C,D,{done:function(E){y.uploads.accessControl=r.createUserAccessViewModel(E.Data.UserAccessList);t(C,y);}});},onAcceptClick:function(C){var D=a(s.fileUploadingMasterForm),E=function(F){p.refreshBox(C.container.find(s.messageBox),F);if(F.Success){try{if(x&&a.isFunction(x)){x(F);}}finally{y.uploads.stopStatusChecking();y.uploads.removeFailedUploads();C.close();}}};a.ajax({type:"POST",cache:false,url:D.attr("action"),data:D.serialize()}).done(function(F){E(F);}).fail(function(F){E(b.parseFailedResponse(F));});return false;},onCloseClick:function(){y.uploads.removeAllUploads();y.uploads.stopStatusChecking();if(w&&a.isFunction(w)){w();}}});}};o.openReuploadFilesDialog=function(w,z,A,y,x){o.openUploadFilesDialog(z,A,y,w,x);};function t(y,B){var x=y.container.find(s.fileUploadingContext).get(0),A=p.box({container:y.container}),G=B.uploads,z={fileName:"Uploading",fileSize:0,fileId:null,version:null,type:null,abort:function(){}},F=new g(z),C=function(){var H=y.container.find(s.folderDropDown);if(H.length>0){var I=y.container.find(s.folderDropDown).get(0).selectedIndex;y.container.find(s.fileUploadingForm).get(0).reset();y.container.find(s.folderDropDown).get(0).selectedIndex=I;}},E,w=function(H){E=setInterval(function(){if(H.uploadProgress()>=100){H.uploadProgress(0);}else{H.uploadProgress(H.uploadProgress()+20);}},200);},D=function(){if(E){clearInterval(E);}};y.container.find(s.uploadButtonLabel).on("click",h);y.container.find(s.fileUploadingForm).find(s.folderDropDown).on("change",function(){var I=a(this).val(),H=y.container.find(s.fileUploadingMasterForm).find(s.folderDropDown);H.val(I);});y.container.find(s.fileUploadingInput).change(function(){var H=y.container.find(s.fileUploadingInput).val();if(H!=null&&H!=""){if(B.reuploadMediaId&&B.reuploadMediaId!=d.defaultReuploadMediaId&&G.uploads().length>0){A.clearMessages();A.addWarningMessage(j.multipleFilesWarningMessageOnReupload);var J=G.uploads();for(var I=0;I<J.length;I++){J[I].activate();}return;}F.uploadCompleted(false);F.fileName=H;F.file.fileName=H;F.uploadProgress(0);G.activeUploads.push(F);G.uploads.push(F);w(F);y.container.find(a(s.fileUploadingForm)).submit();}});y.container.find(a(s.fileUploadingTarget)).on("load",function(){D();G.uploads.remove(F);G.activeUploads.remove(F);C();var M=a(s.fileUploadingTarget).contents().find(s.fileUploadingResult).get(0);if(M==null){return;}var L=a.parseJSON(M.innerHTML);if(L.Success==false){var H=new g(F.file);H.uploadFailed(true);H.failureMessage("");if(L.Messages){var I="";for(var K=0;K<L.Messages.length;K++){I+=L.Messages[K]+" ";}H.failureMessage(I);}G.uploads.push(H);return;}var J=new g(L);J.uploadCompleted(true);J.fileId(L.Id);J.version(L.Version);J.type(L.Type);J.uploadProgress(100);if(L.IsFailed){J.uploadFailed(true);J.failureMessage(j.failedToProcessFile);}else{if(L.IsProcessing){J.uploadProcessing(true);G.startStatusChecking(G.firstTimeout);}}G.uploads.push(J);G.activeUploads.remove(J);});m.applyBindings(G,x);}function v(){var x=this,y=function(z){a.post(a.format(n.undoFileUploadUrl,z.fileId(),z.version(),z.type()));},w=function(z){x.uploads.remove(z);if(x.activeUploads.indexOf(z)!==-1){x.activeUploads.remove(z);}if(z.uploadCompleted()===false&&z.uploadFailed()===false){z.file.abort();}else{if(z.uploadCompleted()===true){y(z);}}};x.uploads=m.observableArray();x.activeUploads=m.observableArray();x.filesToAccept=m.observable("");x.cancelAllActiveUploads=function(){var A=x.activeUploads.removeAll();for(var z=0;z<A.length;z++){w(A[z]);}};x.removeUpload=function(z){w(z);};x.removeAllUploads=function(){var A=x.uploads.removeAll();for(var z=0;z<A.length;z++){w(A[z]);}};x.removeFailedUploads=function(){for(var z=0;z<x.uploads().length;z++){if(x.uploads()[z].uploadFailed()){w(x.uploads()[z]);}}};x.timeout=5000;x.firstTimeout=1000;x.timer=null;x.startStatusChecking=function(z){if(!x.timer){if(!z){z=x.timeout;}x.timer=setTimeout(x.checkStatus,z);}};x.stopStatusChecking=function(){if(x.timer){clearTimeout(x.timer);x.timer=null;}};x.checkStatus=function(){var A=x.getProcessingIds(),B=function(){b.logger.error("Failed to check uploaded files statuses");x.startStatusChecking();},z=false;x.timer=null;if(A.length>0){a.ajax({type:"POST",cache:false,url:n.checkUploadedFileStatuses,data:JSON.stringify({ids:A}),contentType:"application/json; charset=utf-8"}).done(function(I){if(I.Success){if(I.Data&&I.Data.length>0){for(var C=0;C<I.Data.length;C++){var G=I.Data[C],D=G.Id,F=G.IsProcessing===true,E=G.IsFailed===true;if(D){for(var H=0;H<x.uploads().length;H++){if(x.uploads()[H].fileId()==D){if(E){x.uploads()[H].uploadFailed(true);x.uploads()[H].uploadProcessing(false);x.uploads()[H].failureMessage(j.failedToProcessFile);}else{if(!F){x.uploads()[H].uploadProcessing(false);}else{if(F){z=true;}}}}}}}}if(z){x.startStatusChecking();}}else{B();}}).fail(function(C){B();});}};x.getProcessingIds=function(){var A=[],z;for(z=0;z<x.uploads().length;z++){if(x.uploads()[z].uploadProcessing()){A.push(x.uploads()[z].fileId());}}return A;};}function g(w){var x=this;x.file=w;x.fileId=m.observable("");x.version=m.observable(0);x.type=m.observable(0);x.uploadProgress=m.observable(0);x.uploadCompleted=m.observable(false);x.uploadFailed=m.observable(false);x.uploadProcessing=m.observable(false);x.failureMessage=m.observable("");x.uploadSpeedFormatted=m.observable();x.fileName=w.fileName;x.fileSizeFormated=i(w.fileSize);x.isProgressVisible=m.observable(true);x.isActive=m.observable(false);x.uploadCompleted.subscribe(function(y){if(y===true){x.uploadProgress(100);}});x.activate=function(){x.isActive(true);setTimeout(function(){x.isActive(false);},4000);};}function l(y,B){var C=B.uploads,z=y.container.find(s.dragZone),A=p.box({container:y.container}),w=function(D){D.preventDefault();D.stopPropagation();};z.on("dragenter dragover",function(D){w(D);z.addClass(c.dragZoneActive);z.children().hide();return false;});z.on("dragleave drop",function(D){w(D);z.removeClass(c.dragZoneActive);z.children().show();return false;});y.container.find(s.uploadButtonLabel).on("click",h);y.container.find(s.folderDropDown).select2({minimumResultsForSearch:-1});if(f){var x=document.getElementById("bcms-media-uploads");k.initialize({uploadUrl:n.uploadFileToServerUrl,dropContainer:document.getElementById("bcms-files-drop-zone"),inputField:document.getElementById("bcms-files-upload-input"),key:"File",data:{rootFolderId:B.rootFolderId,rootFolderType:B.rootFolderType,reuploadMediaId:B.reuploadMediaId},maxSimultaneousUploads:4,onFileAdded:function(D){var G=document.getElementById(s.overrideSelect);if(G){this.data.shouldOverride=G.options[G.selectedIndex].value;}else{this.data.shouldOverride="true";}if(B.reuploadMediaId&&B.reuploadMediaId!=d.defaultReuploadMediaId&&C.uploads().length>0){A.clearMessages();A.addWarningMessage(j.multipleFilesWarningMessageOnReupload);var I=C.uploads();for(var F=0;F<I.length;F++){I[F].activate();}return;}var E=new g(D);C.activeUploads.push(E);C.uploads.push(E);var H;D.on({onCompleted:function(J){var M=JSON.parse(J);if(M.Success){C.activeUploads.remove(E);E.fileId(M.Data.FileId);E.version(M.Data.Version);E.type(M.Data.Type);clearInterval(H);E.isProgressVisible(true);E.uploadCompleted(true);if(M.Data.IsFailed){E.uploadFailed(true);E.failureMessage(j.failedToProcessFile);}else{if(M.Data.IsProcessing){E.uploadProcessing(true);E.isProgressVisible(false);C.startStatusChecking(C.firstTimeout);}}}else{E.uploadFailed(true);E.failureMessage("");if(M.Messages){var K="";for(var L=0;L<M.Messages.length;L++){K+=M.Messages[L]+" ";}clearInterval(H);E.isProgressVisible(true);E.failureMessage(K);}}},onProgress:function(J){E.uploadProgress(parseInt(J,10));},onError:function(){E.uploadFailed(true);C.activeUploads.remove(E);},onTransfer:function(){E.isProgressVisible(false);if(G){G.disabled=true;}H=setInterval(function(){if(E.uploadProgress()>=100){E.uploadProgress(0);}else{E.uploadProgress(E.uploadProgress()+20);}},200);}});}});m.applyBindings(C,x);}}function h(){if(a.browser.mozilla){a("#"+a(this).attr("for")).click();return false;}return true;}function u(w){return w.toFixed(1).replace(/\.0+$/,"");}function i(z){var x=1024,y=Math.pow(x,2),w=Math.pow(x,3);if(z<x){return z+" B";}if(z<y){return u(z/x)+" KB";}if(z<w){return u(z/y)+" MB";}return u(z/w)+" GB";}o.init=function(){};b.registerInit(o.init);return o;});