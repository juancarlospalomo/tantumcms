bettercms.define("bcms.role",["bcms.jquery","bcms","bcms.autocomplete","bcms.ko.extenders","bcms.ko.grid","bcms.antiXss"],function(a,d,c,f,g,b){var i={},n={},h={loadSiteSettingsRoleUrl:null,loadRolesUrl:null,saveRoleUrl:null,deleteRoleUrl:null,roleSuggestionServiceUrl:null},e={rolesListTabTitle:null,deleteRoleConfirmMessage:null},m=0;i.links=h;i.globalization=e;i.selectors=n;i.initializeRolesList=function(o,q){var p=(q.Success==true)?q.Data:null,r=new k(o,p.Items,p.GridOptions);r.deleteUrl=h.deleteRoleUrl;r.saveUrl=h.saveRoleUrl;f.applyBindings(r,o.get(0));};var k=(function(o){d.extendsClass(p,o);function p(q,s,r){o.call(this,q,h.loadRolesUrl,s,r);}p.prototype.createItem=function(q){var r=new l(this,q);return r;};return p;})(g.ListViewModel);var l=(function(o){d.extendsClass(p,o);function p(r,q){o.call(this,r,q);var s=this;s.name=f.observable().extend({required:"",maxLength:{maxLength:f.maxLength.name},activeDirectoryCompliant:""});s.description=f.observable().extend({maxLength:{maxLength:f.maxLength.name}});s.registerFields(s.name,s.description);s.name(q.Name);s.description(q.Description);s.valueHasFocus=f.observable(false);if(q.IsSystematic===true){s.editingIsDisabled(true);s.deletingIsDisabled(true);}}p.prototype.getDeleteConfirmationMessage=function(){return a.format(e.deleteRoleConfirmMessage,b.encodeHtml(this.name()));};p.prototype.getSaveParams=function(){var q=o.prototype.getSaveParams.call(this);q.Name=this.name();q.Description=this.description();return q;};p.prototype.getRowId=function(){if(!this.rowId){this.rowId="bcms-role-row-"+m++;}return this.rowId;};return p;})(g.ItemViewModel);var j=(function(o){d.extendsClass(p,o);function p(r){var q={serviceUrl:h.roleSuggestionServiceUrl,pattern:"Roles[{0}]"};o.call(this,r,q);}return p;})(c.AutocompleteListViewModel);i.RolesAutocompleteListViewModel=j;i.init=function(){};d.registerInit(i.init);return i;});bettercms.define("bcms.user",["bcms.jquery","bcms","bcms.modal","bcms.siteSettings","bcms.dynamicContent","bcms.role","bcms.media","bcms.messages","bcms.grid","bcms.ko.extenders","bcms.redirect"],function(a,b,r,y,e,u,p,q,h,n,t){var z={},w={siteSettingsUserCreateButton:"#bcms-create-user-button",usersForm:"#bcms-users-form",userForm:"form:first",usersSearchButton:"#bcms-users-search-btn",usersSearchField:".bcms-js-search-box",userCells:"td",userEditButton:".bcms-action-edit",userRowDeleteButton:".bcms-grid-item-delete-button",userParentRow:"tr:first",userNameCell:".bcms-user-name",userFullNameCell:".bcms-user-fullName",userEmailCell:".bcms-user-email",userRowTemplate:"#bcms-users-list-row-template",userTableFirstRow:"table.bcms-tables > tbody > tr:first",userRowTemplateFirstRow:"tr:first",openEditUserProfile:"#bcms-user-profile"},o={loadSiteSettingsUsersUrl:null,loadCreateUserUrl:null,loadEditUserUrl:null,deleteUserUrl:null},g={usersListTabTitle:null,usersAddNewTitle:null,editUserTitle:null,deleteUserConfirmMessage:null},A=null,B=null;z.links=o;z.globalization=g;z.selectors=w;function v(D){h.submitGridForm(D,function(E){A.html(E);k(true);});}function k(E){var D=A.find(w.usersForm);h.bindGridForm(D,function(F){A.html(F);k();});D.on("submit",function(F){b.stopEventPropagation(F);v(D);return false;});b.preventInputFromSubmittingForm(D.find(w.usersSearchField),{preventedEnter:function(){v(D);},});D.find(w.usersSearchButton).on("click",function(){var F=a(this).parent();if(!F.hasClass("bcms-active-search")){D.find(w.usersSearchField).prop("disabled",false);F.addClass("bcms-active-search");D.find(w.usersSearchField).focus();}else{D.find(w.usersSearchField).prop("disabled",true);F.removeClass("bcms-active-search");D.find(w.usersSearchField).val("");}});A.find(w.siteSettingsUserCreateButton).on("click",function(){c();});if(E===true){D.find(w.usersSearchButton).parent().addClass("bcms-active-search");}else{D.find(w.usersSearchField).prop("disabled",true);}l(A);h.focusSearchInput(D.find(w.usersSearchField),true);}function l(D){D.find(w.userCells).on("click",function(){f(a(this));return false;});D.find(w.userRowDeleteButton).on("click",function(){d(a(this));return false;});}z.loadSiteSettingsUsers=function(){var F=[],D=function(H){var I=H.find("input[type=text],textarea,select").filter(":visible:first");if(I){I.focus();}},G=new y.TabViewModel(g.usersListTabTitle,o.loadSiteSettingsUsersUrl,function(H){A=H;k();},D),E=new y.TabViewModel(u.globalization.rolesListTabTitle,u.links.loadSiteSettingsRoleUrl,u.initializeRolesList,D);F.push(G);F.push(E);y.initContentTabs(F);};function c(){var D=function(E){q.refreshBox(A,E);if(E.Success){var G=a(w.userRowTemplate),F=a(G.html()).find(w.userRowTemplateFirstRow);x(F,E.Data);F.insertBefore(A.find(w.userTableFirstRow));l(F);h.showHideEmptyRow(A);}};s(g.usersAddNewTitle,o.loadCreateUserUrl,D);}function f(G){var F=G.parents(w.userParentRow),D=F.find(w.userEditButton).data("id"),E=function(H){q.refreshBox(A,H);if(H.Success){x(F,H.Data);h.showHideEmptyRow(A);}};s(g.editUserTitle,a.format(o.loadEditUserUrl,D),E);}function s(E,F,D){r.open({title:E,onLoad:function(G){e.bindDialog(G,F,{contentAvailable:j,postSuccess:D});}});}function C(D,E,G){var F=this;F.image=n.observable(new p.ImageSelectorViewModel(D));F.roles=new u.RolesAutocompleteListViewModel(E);F.id=G.Id;F.firstName=n.observable(G.FirstName);F.lastName=n.observable(G.LastName);F.userName=n.observable(G.UserName);F.userNameManuallyEdited=false;F.changeUserName=function(){if(b.isEmptyGuid(F.id)&&!F.userNameManuallyEdited){var J="",H=F.firstName(),I=F.lastName();if(H){J+=H;}if(H&&I){J+=".";}if(I){J+=I;}J=J.toLowerCase().replace(/ /g,"");F.userName(J);}};F.userNameOnKeyUp=function(){F.userNameManuallyEdited=true;return true;};F.firstName.subscribe(F.changeUserName);F.lastName.subscribe(F.changeUserName);return F;}function j(E,D){var G=D.Data.Image,H=D.Data.Roles,I=D.Data,F=E.container.find(w.userForm);B=new C(G,H,I);n.applyBindings(B,F.get(0));}function x(E,D){E.find(w.userEditButton).data("id",D.Id);E.find(w.userRowDeleteButton).data("id",D.Id);E.find(w.userRowDeleteButton).data("version",D.Version);E.find(w.userNameCell).html(D.UserName);E.find(w.userFullNameCell).html(D.FullName);E.find(w.userEmailCell).html(D.Email);}function d(J){var I=J.parents(w.userParentRow),E=J.data("id"),L=J.data("version"),G=I.find(w.userNameCell).html(),K=a.format(o.deleteUserUrl,E,L),F=a.format(g.deleteUserConfirmMessage,G),H=function(M){try{q.refreshBox(A,M);if(M.Success){I.remove();h.showHideEmptyRow(A);}}finally{D.close();}},D=r.confirm({content:F,onAccept:function(){a.ajax({type:"POST",url:K,contentType:"application/json; charset=utf-8",dataType:"json",cache:false}).done(function(M){H(M);}).fail(function(M){H(b.parseFailedResponse(M));});return false;}});}function i(){a.validator.addMethod("jqpasswordvalidation",function(H,D,G){if(H){var F=new RegExp(G.pattern).exec(H);G.regex=true;var E=(F&&(F.index===0)&&(F[0].length===H.length));if(!E){return false;}}G.regex=false;return !b.isEmptyGuid(B.id)||H;},function(D){if(D.regex){return D.patternmessage;}return D.message;});a.validator.unobtrusive.adapters.add("passwordvalidation",["pattern","patternmessage"],function(D){D.rules.jqpasswordvalidation={message:D.message,pattern:D.params.pattern,patternmessage:D.params.patternmessage};});}function m(){a(w.openEditUserProfile).on("click",function(){var E=a(this),F=E.data("url"),D=function(G){q.refreshBox(A,G);if(G.Success){t.ReloadWithAlert();}};if(F){r.open({title:g.editUserProfileTitle,onLoad:function(G){e.bindDialog(G,F,{contentAvailable:j,postSuccess:D});}});}});}z.init=function(){b.logger.debug("Initializing bcms.user module.");i();m();};b.registerInit(z.init);return z;});