bettercms.define("bcms.blog",["bcms.jquery","bcms","bcms.modal","bcms.siteSettings","bcms.dynamicContent","bcms.datepicker","bcms.htmlEditor","bcms.grid","bcms.pages","bcms.categories","bcms.ko.extenders","bcms.media","bcms.tags","bcms.ko.grid","bcms.messages","bcms.redirect","bcms.pages.history","bcms.preview","bcms.security","bcms.blog.filter","bcms.sidemenu","bcms.forms","bcms.pages.widgets","bcms.antiXss","bcms.content"],function(a,f,J,Y,q,p,x,v,O,l,E,H,Z,F,I,Q,w,P,T,s,X,t,ae,b,g){var h={},U={datePickers:".bcms-datepicker",htmlEditor:"bcms-blogcontent",firstForm:"form:first",secondForm:"form:nth-child(2)",siteSettingsBlogsListForm:"#bcms-blogs-form",siteSettingsBlogsSearchButton:"#bcms-blogs-search-btn",siteSettingsBlogsSearchInput:".bcms-search-query",siteSettingsBlogCreateButton:"#bcms-create-blog-button",siteSettingsBlogExportButton:"#bcms-export-blogs",siteSettingsBlogImportButton:"#bcms-import-blogs",siteSettingsBlogContentWindow:".bcms-window-options",siteSettingsBlogDeleteButton:".bcms-grid-item-delete-button",siteSettingsBlogParentRow:".bcms-js-list-row:first",siteSettingsBlogEditButton:".bcms-js-edit-button",siteSettingsRowCells:".bcms-js-list-row",siteSettingsBlogCellPrefix:".bcms-blog-",siteSettingsBlogTitleCell:".bcms-page-title",siteSettingsPageStatusTemplatePublished:"#bcms-pagestatus-published-template",siteSettingsPageStatusTemplateUnpublished:"#bcms-pagestatus-unpublished-template",siteSettingsPageStatusTemplateDraft:"#bcms-pagestatus-draft-template",siteSettingsBlogRowTemplate:"#bcms-blogs-list-row-template",siteSettingsBlogRowTemplateFirstRow:".bcms-js-list-row:first",siteSettingsBlogsTableFirstRow:".bcms-list-pages > .bcms-js-list-row:first",overlayConfigure:".bcms-content-configure",overlayDelete:".bcms-content-delete",destroyDraftVersionLink:".bcms-messages-draft-destroy",blogTitle:"#bcms-editor-blog-title",editPermalinkEditField:"#bcms-page-permalink-edit",contentUserConfirmationHiddenField:"#bcms-user-confirmed-region-deletion",blogPostFormDatePickers:"input.bcms-datepicker",importBlogPostsForm:"#bcms-import-blog-posts",fileUploadingTarget:"#bcms-import-form-target",fileUploadingResult:"#jsonResult",categorySelection:"input[name*='Categories']",siteSettingsBlogCloseInfoMessage:"#bcms-addnewblog-closeinfomessage",siteSettingsBlogInfoMessageBox:".bcms-warning-messages",siteSettingsButtonOpener:".bcms-btn-opener",siteSettingsButtonHolder:".bcms-btn-opener-holder",siteSettingsBlogCategoriesSelect:"#bcms-js-categories-select",siteSettingsBlogAuthorsSelect:"#bcms-js-authors-select",siteSettingsBlogLanguagesSelect:"#bcms-js-languages-select",siteSettingsDefaultBlogContentModeSelect:"#bcms-js-content-mode-select",siteSettingsWindow:".bcms-window-settings",hiddenPageNumberField:"#bcms-grid-page-number",contentTab:"#bcms-tab-1",editorContainer:".bcms-window-tabbed-options",editorTitle:".bcms-content-titles",editorInfoBlock:".bcms-content-info-block",blogPermalinkField:".bcms-js-blog-permalink",markdownEditorHeader:".markItUpHeader",markdownEditorFooter:".markItUpFooter",siteSettingsPager:".bcms-top-block-pager",siteSettingsBlogsGrid:"#bcms-blogs-grid"},G={loadSiteSettingsBlogsUrl:null,loadSiteSettingsBlogListsUrl:null,loadCreateNewPostDialogUrl:null,loadEditPostDialogUrl:null,loadAuthorsTemplateUrl:null,loadAuthorsUrl:null,deleteAuthorsUrl:null,saveAuthorsUrl:null,loadBlogPostSettingsUrl:null,saveDefaultTemplateUrl:null,saveBlogPostSettingUrl:null,convertStringToSlugUrl:null,uploadBlogPostsImportFileUrl:null,startImportUrl:null,deleteUploadedFileUrl:null,exportBlogPostsUrl:null,loadTemplatesUrl:null},u={createNewPostDialogTitle:null,editPostDialogTitle:null,deleteBlogDialogTitle:null,deleteAuthorDialogTitle:null,blogPostsTabTitle:null,authorsTabTitle:null,settingsTabTitle:null,datePickerTooltipTitle:null,importBlogPostsTitle:null,closeButtonTitle:null,importButtonTitle:null,uploadButtonTitle:null,multipleFilesWarningMessage:null,pleaseSelectAFile:null,noBlogPostsSelectedToImport:null,editModeHtmlTitle:null,editModeMarkdownTitle:null,templatesTabTitle:null,created:null,lastEdited:null,lastEditedBy:null},m={inactive:"bcms-inactive"},n={blogContent:"blog-post-content"},R=0;h.links=G;h.globalization=u;h.selectors=U;h.senderId=0;h.authorsViewModel=null;h.templatesViewModel=null;function j(ai,ak,ah,al,ag,af){var aj=this;aj.tags=ak;aj.image=E.observable(new H.ImageSelectorViewModel(ai));aj.id=E.observable(ah);aj.version=E.observable(al);aj.editInSourceMode=E.observable(ag);aj.categories=af;}function M(ao,an,ak){ak=a.extend({postSuccess:null,onClose:null,calledFromPage:null,includeChildRegions:false},ak);var ah=T.IsAuthorized(["BcmsEditContent"]),am=ak.postSuccess,aj=ak.onClose,ag=ak.calledFromPage,ai=(ak.includeChildRegions==true),af,al;J.edit({title:an,disableSaveDraft:!ah,isPreviewAvailable:ah,disableSaveAndPublish:!T.IsAuthorized(["BcmsPublishContent"]),onLoad:function(ap){q.bindDialog(ap,ao,{contentAvailable:function(ar,aq){af=z(ar,aq,ag,am,ai);},beforePost:function(){if(!O.isEditedPageUrlManually()){var aq=ap.container.find(U.editPermalinkEditField);al=aq.val();aq.val(null);}var ar=x.isSourceMode(U.htmlContentWidgetContentHtmlEditor);af.editInSourceMode(ar);},postError:function(ar){if(!O.isEditedPageUrlManually()){var aq=ap.container.find(U.editPermalinkEditField);aq.val(al);}if(ar.Data&&ar.Data.ConfirmationMessage){J.confirm({content:ar.Data.ConfirmationMessage,onAccept:function(){ap.container.find(U.contentUserConfirmationHiddenField).val(true);ap.submitForm();return true;}});}},postSuccess:function(aq){if(aq.Data.DesirableStatus==f.contentStatus.preview){try{var ar=aq.Data;af.version(ar.Version);af.id(ar.Id);P.previewPageContent(ar.Id,ar.PageContentId);}finally{return false;}}else{if(a.isFunction(am)){am(aq);}}return true;},formSerialize:function(aq){return ae.serializeFormWithChildWidgetOptions(aq,U.htmlEditor,null,function(ar){if(ai){ar.IncludeChildRegions=true;}});},formContentType:"application/json; charset=utf-8"});},onAccept:function(){x.destroyAllHtmlEditorInstances();},onClose:function(){x.destroyAllHtmlEditorInstances();if(a.isFunction(aj)){aj();}}});}function z(ao,al,ag,ax,av){var an=al.Data,au=an.Image,ay=an.Tags,am=an.ContentTextMode,aw=false,ah=T.IsAuthorized(["BcmsEditContent"]),ai=T.IsAuthorized(["BcmsPublishContent"]),ap=ao.container.find(U.firstForm),ak=ap.find(U.categorySelection),ar=function(){var aB=ao.container.find(U.secondForm).find(U.categorySelection);if(aB!=null&&aB.length>0){var aA=aB.map(function(){return a(this).val();}).get();return aA;}return aB!=null?aB.val():null;},at;if(am==g.contentTextModes.markdown){at={topElements:[{element:U.editorInfoBlock,takeMargins:true},{element:U.blogPermalinkField,takeMargins:true},{element:U.editorTitle,takeMargins:true},{element:U.markdownEditorHeader,takeMargins:true}],parent:U.contentTab,container:U.editorContainer,bottomElement:U.markdownEditorFooter,marginBottom:3};x.initializeMarkdownEditor(U.htmlEditor,"",{},at);}if(am==g.contentTextModes.simpleText){at={topElements:[{element:U.editorInfoBlock,takeMargins:true},{element:U.blogPermalinkField,takeMargins:true},{element:U.editorTitle,takeMargins:true}],parent:U.contentTab,container:U.editorContainer,bottomElement:U.markdownEditorFooter,marginBottom:3};x.initializeMarkdownEditor(U.htmlEditor,"",{hideIcons:true});}if(am==g.contentTextModes.html){at={topElements:[{element:U.editorInfoBlock,takeMargins:true},{element:U.blogPermalinkField,takeMargins:true},{element:U.editorTitle,takeMargins:true}],container:U.editorContainer,parent:U.contentTab,marginBottom:1};x.initializeHtmlEditor(U.htmlEditor,an.ContentId,{},an.EditInSourceMode,at);}if(an.Version==0){aw=true;}var aq=O.initializePermalinkBox(ao,false,G.convertStringToSlugUrl,U.blogTitle,aw,null,null,ar);if(aw&&ak!=null){ak.on("change",function(){aq.Regenerate();});}var az=new Z.TagsListViewModel(ay);var aj=new l.CategoriesSelectListModel(an.Categories,ao.container);var af=new j(au,az,an.Id,an.Version,an.EditInSourceMode,aj);l.initCategoriesSelect(aj,al.Data.CategoriesLookupList,ao.container);a(U.siteSettingsBlogLanguagesSelect).select2({minimumResultsForSearch:-1});a(U.siteSettingsBlogAuthorsSelect).select2({minimumResultsForSearch:-1});E.applyBindings(af,ao.container.find(U.firstForm).get(0));ao.container.find(U.destroyDraftVersionLink).on("click",function(){w.destroyDraftVersion(an.ContentId,an.ContentVersion,av,ao.container,function(aD,aA){var aC=ax,aB=null;ao.close();if(ag){aB=function(){aC(aA);};}r(an.Id,{postSuccess:aC,calledFromPage:ag,onClose:aB,includeChildRegions:av});});});if(ap.data("readonly")!==true&&ai&&!ah){ap.addClass(m.inactive);t.setFieldsReadOnly(ap);a.each(ap.find(U.blogPostFormDatePickers),function(){var aA=a(this);aA.removeAttr("readonly");aA.parent("div").css("z-index",f.getHighestZindex()+1);});}ao.container.find(U.siteSettingsBlogCloseInfoMessage).on("click",function(){ao.container.find(U.siteSettingsBlogInfoMessageBox).hide();});ao.container.find(U.datePickers).initializeDatepicker(u.datePickerTooltipTitle);return af;}h.postNewArticle=function(){var af=function(ag){if(ag&&ag.Data&&ag.Data.PageUrl){X.turnEditModeOn();Q.RedirectWithAlert(ag.Data.PageUrl);}};o(af);};function o(af){var ah=a.format(G.loadCreateNewPostDialogUrl,window.location.pathname),ag=u.createNewPostDialogTitle;M(ah,ag,{postSuccess:af});}function r(af,ag){ag=a.extend({postSuccess:null,calledFromPage:false,onClose:null,includeChildRegions:false},ag);var ai=a.format(G.loadEditPostDialogUrl,af),ah=u.editPostDialogTitle;M(ai,ah,{postSuccess:ag.postSuccess,onClose:ag.onClose,calledFromPage:ag.calledFromPage,includeChildRegions:ag.includeChildRegions});}function K(ag,af){if(ag.Data!=null){af.update(ag.Data);}}function k(ag,ah,af){var ai=this;ai.items=E.observableArray();ai.items.extend({rateLimit:50});ai.setItems=function(aj){ai.items.removeAll();for(var ak=0;ak<aj.length;ak++){ai.items.push(new i(aj[ak]));}};ai.onOpenPage=function(aj){ah.find(U.hiddenPageNumberField).val(aj);v.submitGridFormPaged(ah,function(ak,al){ai.setItems(al.Items);});};ai.setItems(ag.Items);ai.paging=new E.PagingViewModel(ag.GridOptions.PageSize,ag.GridOptions.PageNumber,ag.GridOptions.TotalCount,ai.onOpenPage);return ai;}function i(af){var ag=this;ag.id=E.observable(af.Id);ag.title=E.observable(af.Title);ag.createdOn=E.observable(u.created+" "+af.CreatedOn);ag.modifiedOn=E.observable(u.lastEdited+" "+af.ModifiedOn);ag.modifiedByUser=E.observable(u.lastEditedBy+" "+af.ModifiedByUser);ag.pageStatus=E.observable(af.Status);ag.url=E.observable(af.PageUrl);ag.version=E.observable(af.Version);ag.update=function(ah){ag.id(ah.Id);ag.title(ah.Title);ag.createdOn(u.created+" "+ah.CreatedOn);ag.modifiedOn(u.lastEdited+" "+ah.ModifiedOn);ag.modifiedByUser(u.lastEditedBy+" "+ah.ModifiedByUser);ag.pageStatus(ah.Status);ag.url(ah.PageUrl);ag.version(ah.Version);};ag.onEditClick=function(ah){var ai=function(aj){K(aj,ag);};r(ag.id(),{postSuccess:ai,calledFromPage:false});};ag.onTitleClick=function(ah){window.open(ag.url());};ag.onDeleteClick=function(ah){O.deletePage(ag.id(),function(ai){h.blogsGridViewModel.items.remove(ag);},u.deleteBlogDialogTitle);};}function C(af,ag,al,ak,aj){var ah=af.find(U.siteSettingsBlogsListForm);h.blogsGridViewModel=new k(((ag.Data)?ag.Data:al),ah,af);var ai=af.find(U.siteSettingsBlogsGrid);E.cleanNode(ai.get(0));var am=af.find(U.siteSettingsPager);E.applyBindings(h.blogsGridViewModel,ai.get(0));E.applyBindings(h.blogsGridViewModel.paging,am.get(0));v.bindGridForm(ah,function(ao,an){af.html(ao);C(af,ao,an);});ah.on("submit",function(an){f.stopEventPropagation(an);S(af,ah,true);return false;});f.preventInputFromSubmittingForm(ah.find(U.siteSettingsBlogsSearchInput),{preventedEnter:function(){S(af,ah,true);}});ah.find(U.siteSettingsBlogTitleCell).on("click",function(an){f.stopEventPropagation(an);});ah.find(U.siteSettingsBlogsSearchButton).on("click",function(){var an=a(this).parent();if(!an.hasClass("bcms-active-search")){ah.find(U.siteSettingsBlogsSearchInput).prop("disabled",false);an.addClass("bcms-active-search");ah.find(U.siteSettingsBlogsSearchInput).focus();}else{ah.find(U.siteSettingsBlogsSearchInput).prop("disabled",true);an.removeClass("bcms-active-search");ah.find(U.siteSettingsBlogsSearchInput).val("");}});ah.find(U.siteSettingsButtonOpener).on("click",function(an){f.stopEventPropagation(an);var ao=ah.find(U.siteSettingsButtonHolder);if(!ao.hasClass("bcms-opened")){ao.addClass("bcms-opened");}else{ao.removeClass("bcms-opened");}});f.on(f.events.bodyClick,function(an){var ao=ah.find(U.siteSettingsButtonHolder);if(ao.hasClass("bcms-opened")){ao.removeClass("bcms-opened");}});af.find(U.siteSettingsBlogCreateButton).on("click",function(){o(function(an){h.blogsGridViewModel.items.unshift(new i(an.Data));});});af.find(U.siteSettingsBlogExportButton).on("click",function(){var an=a.format("{0}?{1}",G.exportBlogPostsUrl,ah.serialize());window.location.href=an;});af.find(U.siteSettingsBlogImportButton).on("click",function(){N(af,ah);});if(ak){ah.find(U.siteSettingsBlogsSearchButton).parent().addClass("bcms-active-search");}else{ah.find(U.siteSettingsBlogsSearchInput).prop("disabled",true);}s.bind(af,((ag.Data)?ag.Data:al),function(an){S(af,ah,ak,an);},aj);v.focusSearchInput(af.find(U.siteSettingsBlogsSearchInput),true);}function S(af,ag,ah){if(ah){v.submitGridFormPaged(ag,function(aj,ai){h.blogsGridViewModel.setItems(ai.Items);h.blogsGridViewModel.paging.setPaging(ai.GridOptions.PageSize,ai.GridOptions.PageNumber,ai.GridOptions.TotalCount);});}else{v.submitGridForm(ag,function(aj,ai){h.blogsGridViewModel.setItems(ai.Items);h.blogsGridViewModel.paging.setPaging(ai.GridOptions.PageSize,ai.GridOptions.PageNumber,ai.GridOptions.TotalCount);});}}h.loadSiteSettingsBlogs=function(){var aj=[],ai=function(al){var am=al.find("input[type=text],textarea,select").filter(":visible:first");if(am){am.focus();}};var ag=new Y.TabViewModel(u.blogPostsTabTitle,G.loadSiteSettingsBlogsUrl,C,ai);aj.push(ag);if(T.IsAuthorized(["BcmsEditContent"])){var af=new Y.TabViewModel(u.authorsTabTitle,G.loadAuthorsTemplateUrl,B,ai);var ak=new Y.TabViewModel(u.templatesTabTitle,G.loadTemplatesUrl,D,ai);var ah=new Y.TabViewModel(u.settingsTabTitle,G.loadBlogPostSettingsUrl,A,ai);aj.push(af);aj.push(ak);aj.push(ah);}Y.initContentTabs(aj);};function B(af,ai){var ah=ai.Html,ag=(ai.Success==true)?ai.Data:null;af.html(ah);h.authorsViewModel=new d(af,ag.Items,ag.GridOptions);h.authorsViewModel.deleteUrl=G.deleteAuthorsUrl;h.authorsViewModel.saveUrl=G.saveAuthorsUrl;E.applyBindings(h.authorsViewModel,af.get(0));}var c=(function(af){f.extendsClass(ag,af);function ag(ah){var ai=this;ai.parent=ah;af.call(this);ai.onAfterAction=function(){if(ai.parent.isActive()){ai.parent.hasFocus(true);}return true;};ai.onBeforeAction=function(){ai.parent.isSelected=true;ai.parent.isActive(true);return true;};}ag.prototype.select=function(ah,ai){this.onBeforeAction();af.prototype.select.call(this,ah,ai);};ag.prototype.preview=function(ah,ai){f.stopEventPropagation();if(this.parent.isActive()){this.onBeforeAction();}af.prototype.preview.call(this,ah,ai);};ag.prototype.remove=function(ah,ai){this.onBeforeAction();af.prototype.remove.call(this,ah,ai);};ag.prototype.onAfterSelect=function(){this.onAfterAction();};ag.prototype.onAfterRemove=function(){this.onAfterAction();};ag.prototype.onAfterPreview=function(){this.onAfterAction();};ag.prototype.onSelectClose=function(){this.onAfterAction();};return ag;})(H.ImageSelectorViewModel);var d=(function(af){f.extendsClass(ag,af);function ag(ah,aj,ai){af.call(this,ah,G.loadAuthorsUrl,aj,ai);}ag.prototype.createItem=function(ah){var ai=new e(this,ah);return ai;};return ag;})(F.ListViewModel);var e=(function(af){f.extendsClass(ag,af);function ag(ai,ah){af.call(this,ai,ah);var aj=this;aj.name=E.observable().extend({required:"",maxLength:{maxLength:E.maxLength.name},activeDirectoryCompliant:""});aj.description=E.observable();aj.image=E.observable(new c(aj));aj.oldImageId=ah.Image!=null?ah.Image.ImageId:"";aj.registerFields(aj.name,aj.image().id,aj.image().url,aj.image().thumbnailUrl,aj.image().tooltip,aj.description);aj.name(ah.Name);aj.description(ah.Description);aj.image().setImage(ah.Image||{});}ag.prototype.getDeleteConfirmationMessage=function(){return a.format(u.deleteAuthorDialogTitle,b.encodeHtml(this.name()));};ag.prototype.getSaveParams=function(){var ah=af.prototype.getSaveParams.call(this);ah.Name=this.name();ah.Description=this.description();ah.Image={ImageId:this.image().id()};return ah;};ag.prototype.hasChanges=function(){var ah=af.prototype.hasChanges.call(this);if(!ah){ah=(this.image().id()||"")!=this.oldImageId;}return ah;};ag.prototype.onAfterItemSaved=function(ah){af.prototype.onAfterItemSaved.call(this,ah);this.oldImageId=this.image().id();};ag.prototype.getRowId=function(){if(!this.rowId){this.rowId="bcms-author-row-"+R++;}return this.rowId;};return ag;})(F.ItemViewModel);var W=(function(af){f.extendsClass(ag,af);function ag(ah,aj,ai){af.call(this,ah,G.loadAuthorsUrl,aj,ai);}ag.prototype.createItem=function(ah){var ai=new V(this,ah);return ai;};return ag;})(F.ListViewModel);var V=(function(af){f.extendsClass(ag,af);function ag(ai,ah){af.call(this,ai,ah);var aj=this;aj.name=E.observable();aj.key=E.observable();aj.value=E.observable().extend({required:""});aj.valueTitle=E.observable();aj.registerFields(aj.value);aj.contentEditModes=[];aj.contentEditModes.push({id:1,name:u.editModeHtmlTitle});aj.contentEditModes.push({id:2,name:u.editModeMarkdownTitle});aj.value.subscribe(function(al){for(var ak=0;ak<aj.contentEditModes.length;ak++){if(aj.contentEditModes[ak].id==al){aj.valueTitle(aj.contentEditModes[ak].name);break;}}});aj.key(ah.Key);aj.name(ah.Name);aj.value(ah.Value);}ag.prototype.getSaveParams=function(){var ah=af.prototype.getSaveParams.call(this);ah.Value=this.value();ah.Key=this.key();return ah;};ag.prototype.onAfterItemSaved=function(ah){af.prototype.onAfterItemSaved.call(this,ah);};ag.prototype.getRowId=function(){if(!this.rowId){this.rowId="bcms-blog-settings-row-"+R++;}return this.rowId;};return ag;})(F.ItemViewModel);function D(af,ah){var ag=ah.Html,ai=(ah.Success==true)?ah.Data:null;af.html(ag);h.templatesViewModel=new ab(ai,af);E.applyBindings(h.templatesViewModel,af.get(0));}function A(ag,aj){var ai=aj.Html,af=(aj.Success==true&&aj.Data)?aj.Data.Items:null,ah=(aj.Success==true&&aj.Data)?aj.Data.GridOptions:{},ak=new W(ag,af,ah);ak.saveUrl=G.saveBlogPostSettingUrl;ag.html(ai);E.applyBindings(ak,ag.get(0));}function aa(){var af=this;af.templates=E.observableArray();}function ab(aj,af){var ai=this;ai.templates=E.observableArray();ai.displayedTemplates=E.observableArray();ai.searchQuery=E.observable();ai.searchEnabled=E.observable(false);ai.hasFocus=E.observable(false);for(var ah=0;ah<aj.length;ah++){var ag=new ac(aj[ah],this,af);ai.templates.push(ag);}ai.displayTemplates=function(){if(ai.templates()!=null){ai.displayedTemplates.removeAll();var am=(ai.searchQuery()||"").toLowerCase();for(var al=0;al<ai.templates().length;al++){var ak=ai.templates()[al];if(am&&ak.title.toLowerCase().indexOf(am)<0){continue;}ai.displayedTemplates.push(ak);}}};ai.search=function(){ai.displayTemplates();};ai.toggleSearch=function(){if(!ai.searchEnabled()){ai.searchEnabled(true);ai.hasFocus(true);}else{ai.searchEnabled(false);ai.searchQuery("");}};ai.displayTemplates();}function ac(ai,ag,af){var ah=this;ah.id=ai.TemplateId;ah.parent=ag;ah.previewUrl=ai.PreviewUrl;ah.title=ai.Title;ah.container=af.closest(U.siteSettingsWindow).length>0?af.closest(U.siteSettingsWindow):af;ah.isActive=E.observable(ai.IsActive);ah.isCompatible=ai.IsCompatible;ah.isMasterPage=ai.IsMasterPage;ah.select=function(){var ak=ah.isMasterPage?a.format(G.saveDefaultTemplateUrl,"00000000-0000-0000-0000-000000000000",ah.id):a.format(G.saveDefaultTemplateUrl,ah.id),aj=function(am){ah.container.hideLoading();I.refreshBox(ah.container,am);if(am.Success==true){for(var al=0;al<ah.parent.templates().length;al++){ah.parent.templates()[al].unselect();}ah.isActive(true);}};ah.container.showLoading();a.ajax({type:"POST",cache:false,url:ak}).done(function(al){aj(al);}).fail(function(al){aj(f.parseFailedResponse(al));});};ah.unselect=function(){ah.isActive(false);};ah.previewImage=function(){J.imagePreview(ah.previewUrl,ah.title);};}function L(af){if(af.contentType==n.blogContent){af.onEditContent=function(ai,ag){var ah=function(ak){if(a.isFunction(ai)){ai(ak);}else{Q.ReloadWithAlert();}},aj={postSuccess:ah,calledFromPage:true,includeChildRegions:ag};r(f.pageId,aj);};af.visibleButtons.configure=false;af.visibleButtons["delete"]=false;}}function y(af){var ag=this;ag.success=af.Success===true;ag.checked=E.observable(af.Success===true);ag.id=af.Id;ag.title=af.Title||"&nbsp;";ag.url=af.PageUrl;ag.errorMessage=af.ErrorMessage;ag.warnMessage=af.WarnMessage;ag.skipped=false;ag.checked.subscribe(function(ah){ag.skipped=!ah;});ag.toJson=function(){return{Id:ag.id,Title:ag.title,PageUrl:ag.url};};}function ad(ag,ai){var af,ah;for(af=0;af<ai.length;af++){ah=ai[af];ag.results.push(new y(ah));}}function N(ak,al){var ai,ah,aj,ag,af;J.open({title:u.importBlogPostsTitle,acceptTitle:u.uploadButtonTitle,cancelTitle:u.closeButtonTitle,onLoad:function(am){q.bindDialog(am,G.uploadBlogPostsImportFileUrl,{contentAvailable:function(an,ap){var ao=an.container.find(a(U.fileUploadingTarget)),aq=function(){ai.started=false;ag.hideLoading();var at=ao.contents().find(U.fileUploadingResult).get(0);if(!at){return true;}try{ap=a.parseJSON(at.innerHTML);I.refreshBox(ag,ap);if(ap.Success){ai.uploaded(true);ai.dialog.model.buttons()[0].title(u.importButtonTitle);if(ap.Data&&a.isArray(ap.Data.Results)){ad(ai,ap.Data.Results);ai.fileId=ap.Data.FileId;}}}catch(ar){f.logger.error(ar);}};ag=an.container.find(U.importBlogPostsForm);af=an.container.find(U.siteSettingsBlogContentWindow);ai={createRedirects:E.observable(true),reuseExistingCategories:E.observable(false),recreateCategoryTree:E.observable(true),fileName:E.observable(""),fixedFileName:E.observable(""),messageBox:I.box({container:ag}),form:ag,results:E.observableArray(),uploaded:E.observable(false),finished:E.observable(false),dialog:an,fileId:"",checkedAll:E.observable(true)};ai.fileName.subscribe(function(ar){if(ar){ar=ar.toUpperCase().replace("C:\\FAKEPATH\\","");}ai.fixedFileName(ar);});ai.reuseExistingCategories.subscribe(function(ar){ai.recreateCategoryTree(!ar);});ai.recreateCategoryTree.subscribe(function(ar){ai.reuseExistingCategories(!ar);});ai.checkedAll.subscribe(function(ar){for(ah=0;ah<ai.results().length;ah++){aj=ai.results()[ah];aj.checked(ar);}});ao.on("load",aq);E.applyBindings(ai,ag.get(0));},});},onAcceptClick:function(){var an,am=function(aq){var ao=[],ap;af.hideLoading();I.refreshBox(ag,aq);if(aq.Success==true){ai.finished(true);ai.dialog.model.buttons()[0].disabled(true);for(ah=0;ah<ai.results().length;ah++){aj=ai.results()[ah];if(aj.success&&!aj.skipped){for(ap=0;ap<aq.Data.Results.length;ap++){if(aq.Data.Results[ap].PageUrl==aj.url||(aj.id&&(aj.id==aq.Data.Results[ap].Id))){aj=new y(aq.Data.Results[ap]);break;}}}ao.push(aj);}ai.results.removeAll();for(ah=0;ah<ao.length;ah++){ai.results.push(ao[ah]);}}};if(!ai.uploaded()){if(!ai.fileName()){ai.messageBox.clearMessages();ai.messageBox.addErrorMessage(u.pleaseSelectAFile);}else{if(!ai.started){af.showLoading();ai.started=true;ai.form.submit();af.hideLoading();}}}else{an={BlogPosts:[],CreateRedirects:ai.createRedirects(),ReuseExistingCategories:ai.reuseExistingCategories(),RecreateCategoryTree:ai.recreateCategoryTree(),FileId:ai.fileId};for(ah=0;ah<ai.results().length;ah++){aj=ai.results()[ah];if(aj.success&&aj.id&&aj.checked()){an.BlogPosts.push(aj.toJson());}}if(an.BlogPosts.length>0){af.showLoading();a.ajax({type:"POST",contentType:"application/json; charset=utf-8",cache:false,url:G.startImportUrl,data:JSON.stringify(an)}).done(function(ao){am(ao);}).fail(function(ao){am(f.parseFailedResponse(ao));});}else{ai.messageBox.clearMessages();ai.messageBox.addWarningMessage(u.noBlogPostsSelectedToImport);}}},onCloseClick:function(){if(ai.finished()){S(ak,al);}else{if(ai.uploaded()&&ai.fileId){a.ajax({type:"POST",cache:false,url:a.format(G.deleteUploadedFileUrl,ai.fileId)});}}}});}h.init=function(){f.logger.debug("Initializing bcms.blog module.");};f.on(f.events.contentModelCreated,L);f.registerInit(h.init);return h;});bettercms.define("bcms.blog.filter",["bcms.jquery","bcms","bcms.ko.extenders","bcms.tags","bcms.categories"],function(a,b,g,k,c){var d={},i={filterTemplate:"#bcms-filter-template",filterByLanguage:"#bcms-js-filter-languages",filterByStatus:"#bcms-js-filter-status",filterBySeoStatus:"#bcms-js-filter-seostatus"},h={},f={};d.links=h;d.globalization=f;function j(o,l,m){var n=this;n.title=o;n.column=l;n.direction=m;return n;}function e(r,l,m,p,o,n){var q=this;q.isVisible=g.observable(n);q.tags=r;q.categories=l;q.includeArchived=g.observable(false);q.languageId=g.observable(o.LanguageId);q.languages=o.Languages||[];q.status=g.observable(o.Status);q.statuses=o.Statuses||[];q.seoStatus=g.observable(o.SeoStatus);q.seoStatuses=o.SeoStatuses||[];q.languages.unshift({Key:"",Value:""});q.statuses.unshift({Key:"",Value:""});q.seoStatuses.unshift({Key:"",Value:""});q.showSorting=g.observable(false);q.sortColumn=g.observable(o.GridOptions.Column);q.sortDirection=g.observable(o.GridOptions.Direction);q.sortFields=g.observableArray([]);q.suspendSortingSelector=false;if(o.SortAliases){o.SortAliases.forEach(function(s){q.sortFields.push(new j(s.Title,s.Column,s.Direction));});}q.isEdited=g.computed(function(){if(q.includeArchived()){return true;}if(q.tags!=null&&q.tags.items()!=null&&q.tags.items().length>0){return true;}if(q.categories!=null&&q.categories.items()!=null&&q.categories.items().length>0){return true;}if(q.languageId()||q.seoStatus()||q.status()){return true;}return false;});q.form=m.find(i.siteSettingsPagesListForm);q.toggleShowSorting=function(){q.showSorting(!q.showSorting());q.suspendSortingSelector=true;setTimeout(function(){q.suspendSortingSelector=false;},100);};q.applySort=function(t,s,u){q.sortColumn(s);q.sortDirection(u);q.showSorting(false);q.form.find(i.hiddenSortColumnField).val(s);q.form.find(i.hiddenSortDirectionField).val(u);p(true);};q.toggleFilter=function(){q.isVisible(!q.isVisible());};q.closeFilter=function(){q.isVisible(false);};q.searchWithFilter=function(s){if(a.isFunction(p)){p(s);}};q.clearFilter=function(){q.tags.items([]);q.categories.items([]);q.includeArchived(false);q.languageId("");q.status("");q.seoStatus("");q.searchWithFilter(true);};q.changeIncludeArchived=function(){q.includeArchived(!(q.includeArchived()));};b.on(b.events.bodyClick,function(){if(!q.suspendSortingSelector){if(q.showSorting()==true){q.showSorting(false);}}});}d.bind=function(m,p,q,o){var r=new k.TagsListViewModel(p.Tags),l=new c.CategoriesSelectListModel(p.Categories),n=new e(r,l,m,q,p,o);n.includeArchived(p.IncludeArchived?true:false);c.initCategoriesSelect(l,p.CategoriesLookupList);g.applyBindings(n,m.find(i.filterTemplate).get(0));};d.init=function(){b.logger.debug("Initializing bcms.blog.filter module.");};b.registerInit(d.init);return d;});